"use strict";(self.webpackChunktrading_game=self.webpackChunktrading_game||[]).push([[53],{9286:(t,e,s)=>{s.d(e,{Z:()=>i});const i=s.p+"d9a19c5129d77f766d26840b9e76c785.png"},3033:(t,e,s)=>{s.d(e,{I:()=>i});class i{constructor(t){t.h||t.s||t.v?(this.hsv=t,this.rgb=void 0):(this.rgb=t,this.hsv=void 0)}static rgb(t,e,s){return new i({r:t,g:e,b:s})}static hsv(t,e,s){return new i({h:t,s:e,v:s})}r(t){if(this.reqRgb(),void 0===t)return this.rgb.r;this.rgb.r=t,this.hsv=void 0}g(t){if(this.reqRgb(),void 0===t)return this.rgb.g;this.rgb.g=t,this.hsv=void 0}b(t){if(this.reqRgb(),void 0===t)return this.rgb.b;this.rgb.b=t,this.hsv=void 0}h(t){if(this.reqHsv(),void 0===t)return this.hsv.h;this.hsv.h=t,this.hsv=void 0}s(t){if(this.reqHsv(),void 0===t)return this.hsv.s;this.hsv.s=t,this.hsv=void 0}v(t){if(this.reqHsv(),void 0===t)return this.hsv.v;this.hsv.v=t,this.hsv=void 0}componentToRgb(t){const e=(t+6*this.hsv.h)%6;return this.hsv.v-this.hsv.v*this.hsv.s*Math.max(Math.min(e,4-e,1),0)}reqRgb(){void 0===this.rgb&&this.calcRgb()}calcRgb(){this.rgb={r:this.componentToRgb(5),g:this.componentToRgb(3),b:this.componentToRgb(1)}}reqHsv(){void 0===this.hsv&&this.calcHsv()}calcHsv(){const{r:t,g:e,b:s}=this.rgb,i=Math.max(t,e,s),n=Math.min(t,e,s);let o=i===n?0:i===t?(e-s)/(i-n):i===e?2+(s-t)/(i-n):4+(t-e)/(i-n);for(o/=6;o<0;)o++;this.hsv={h:o,s:i===n?0:(i-n)/i,v:i}}toString(){return this.reqRgb(),"rgb("+this.toByte(this.rgb.r)+", "+this.toByte(this.rgb.g)+", "+this.toByte(this.rgb.b)+")"}toByte(t){return Math.floor(255*t)}}},6718:(t,e,s)=>{s.d(e,{Z:()=>o});class i{constructor(t,e){this.keys=t,this.changes=e}isKeyDown(t){return-1!==this.keys.indexOf(t)}isKeyUp(t){return-1===this.keys.indexOf(t)}}class n{constructor(t,e){this.attachedElement=t,this.logKeyNames=e,void 0===this.logKeyNames&&(this.logKeyNames=!1),t.addEventListener("keydown",(t=>this.onKeyDown(t))),t.addEventListener("keyup",(t=>this.onKeyUp(t))),this.downKeys=[],this.changes=[]}onKeyDown(t){this.logKeyNames&&console.log(t.key),-1===this.downKeys.indexOf(t.key)&&(this.changes.push({key:t.key,change:"press"}),this.downKeys.push(t.key))}onKeyUp(t){this.changes.push({key:t.key,change:"release"});const e=this.downKeys.indexOf(t.key);this.downKeys.splice(e,1)}Update(){const t=this.downKeys,e=this.changes;return this.downKeys=t.slice(),this.changes=[],new i(t,e)}}class o{constructor(t,e){this.watcher=new n(t,e),this.prvState=this.currentState=this.watcher.Update()}update(){this.prvState=this.currentState,this.currentState=this.watcher.Update()}isKeyDown(t){return this.currentState.isKeyDown(t)}isKeyUp(t){return this.currentState.isKeyUp(t)}isKeyPressed(t){return this.currentState.isKeyDown(t)&&this.prvState.isKeyUp(t)}isKeyReleased(t){return this.currentState.isKeyUp(t)&&this.prvState.isKeyDown(t)}changes(){return this.currentState.changes}}},9444:(t,e,s)=>{s.d(e,{r7:()=>n,Yw:()=>o});var i=s(5803);class n{constructor(t,e){this.range=t,this.timingFunction=e}static linear(t,...e){return new n((0,i.M)(t,...e),(t=>t))}}class o{constructor(t){this.totalTime=t,this.elapsedTime=0}tick(){return this.elapsedTime++,this.elapsedTime>=this.totalTime}sample(t){return t.range.sample(t.timingFunction(this.elapsedTime/this.totalTime))}}},5803:(t,e,s)=>{s.d(e,{M:()=>r});var i=s(3033);const n=(t,e,s)=>t+(e-t)*s,o=(t,e,s)=>i.I.rgb(n(t.r(),e.r(),s),n(t.g(),e.g(),s),n(t.b(),e.b(),s));function r(t,...e){"function"!=typeof t&&(e.splice(0,0,t),t=void 0);let s=1/(e.length-1),i=new a(e[0],t);for(let t=1;t<e.length;t++)i.addKeyFrame(s*t,e[t]);return i}class a{constructor(t,e){if(void 0===e)if("number"==typeof t)this.interpolator=n;else{if(void 0===t.r)throw"No default interpolator found";this.interpolator=o}else this.interpolator=e;this.keys=[{time:0,value:t}]}addKeyFrame(t,e){for(let s=0;s<this.keys.length;s++)if(t<this.keys[s].time)return void this.keys.splice(s,0,{time:t,value:e});this.keys.push({time:t,value:e})}sample(t){if(1===this.keys.length)return this.keys[0].value;for(var e=0;this.keys[e+1].time<t&&e+2<this.keys.length;)e++;let s=this.keys[e+1].time-this.keys[e].time,i=(t-this.keys[e].time)/s;return this.interpolator(this.keys[e].value,this.keys[e+1].value,i)}}},912:(t,e,s)=>{s.r(e),s.d(e,{default:()=>Ie});var i=s(7363),n=s(127),o=s(5901),r=s(7604),a=s(6718),h=s(8785);const l=32,c=32,d=new h.Z(16,24),p=(new h.Z(l,c),new h.Z(16,16)),u=416,g=new h.Z(192,192),m=new h.Z(-2,4);var w=s(3486);const f=s.p+"bbf8a045bebfe2eac617ebbf02e24769.png",y=s.p+"b1ad2b17beecab6f53f7b70fab951c0e.png",v=s.p+"b5124a83d98bc334e6e3de5f7e27e05f.png",A=s.p+"92efb3d656356bbd02c1f86bf78275d7.png",Z=s.p+"b78374db2fae35ea358c6a9e2b27ccd6.png",b=s.p+"6c72c5024765beedd162e66308ac2e23.png",k=s.p+"03a3f451813fb76552aa69688d48cdef.png",M=s.p+"c2ee93d666dd13067fc8adea399b804c.png",x=s.p+"e0a2f6d93614a82e9ed3897bd04abb85.png";var I=s(9286);const T=s.p+"e7f4f4d72842e51e822a7c73f3b7a715.png";var S,R=s(5922),L=s(1413),P=s(5907);!function(t){t[t.Right=0]="Right",t[t.DownRight=1]="DownRight",t[t.DownLeft=2]="DownLeft",t[t.Left=3]="Left",t[t.UpLeft=4]="UpLeft",t[t.UpRight=5]="UpRight"}(S||(S={}));const _=[S.Right,S.DownRight,S.DownLeft,S.Left,S.UpLeft,S.UpRight];class D{static ToAngle(t){return Math.PI*t/3-Math.PI/2}static ToPoint(t){switch(t){case S.Right:return new h.Z(1,0);case S.DownRight:return new h.Z(0,1);case S.DownLeft:return new h.Z(-1,1);case S.Left:return new h.Z(-1,0);case S.UpLeft:return new h.Z(0,-1);case S.UpRight:return new h.Z(1,-1)}}static FromPoint(t){return t.x>0&&0===t.y?S.Right:t.x<0&&0===t.y?S.Left:0===t.x&&t.y>0?S.DownRight:0===t.x&&t.y<0?S.UpLeft:t.x>0&&t.x===-t.y?S.UpRight:t.x<0&&t.x===-t.y?S.DownLeft:void 0}static TryGetDirectionAndDistance(t){if(0===t.x||0===t.y||t.x===-t.y)return{direction:this.FromPoint(new h.Z(Math.sign(t.x),Math.sign(t.y))),distance:q(t)}}static Turn(t,e){return((t+e)%6+6)%6}}function E(t,e){for(let s=0;s<(null!=e?e:1);s++)t=new h.Z(-t.y,t.x+t.y);return t}function F(t,e){for(let s=0;s<(null!=e?e:1);s++)t=new h.Z(t.x+t.y,-t.x);return t}function C(t){return h.Z.add(h.Z.multiply(d,t.y),32*t.x+g.x,g.y)}function q(t){return Math.sign(t.x)===-Math.sign(t.y)?Math.max(Math.abs(t.x),Math.abs(t.y)):Math.abs(t.x)+Math.abs(t.y)}function B(t){if(0===t)return[new h.Z(0,0)];const e=[];let s=new h.Z(0,-t);for(var i=S.Right;i<=S.UpRight;i++)for(var n=D.ToPoint(i),o=0;o<t;o++)e.push(s),s=h.Z.add(s,n);return e}const H=new h.Z(8,26);class U{constructor(t){this.emptyHpImage=new L.Z(t.image,new P.Z(0,0,4,5)),this.redHpImage=new L.Z(t.image,new P.Z(3,0,4,5)),this.yellowHpImage=new L.Z(t.image,new P.Z(6,0,4,5)),this.blueHpImage=new L.Z(t.image,new P.Z(9,0,4,5))}draw(t,e,s,i){const n=Math.ceil(i/5);let o=i%5;0===o&&(o=5);const r=s<=i/4?this.redHpImage:s<=i/2?this.yellowHpImage:this.blueHpImage,a=this.emptyHpImage;let l=h.Z.add(C(e),H);for(let e=0;e<n-1;e++){const i=-2*(n-e-1);for(let e=0;e<5;e++){let n=s<=0?a:r;s--,n.draw(t,new P.Z(l.x+3*e,l.y+i,4,5),0)}}const c=3*(5-o)/2;for(let e=0;e<o;e++){let i=s<=0?a:r;s--,i.draw(t,new P.Z(l.x+3*e+c,l.y,4,5),0)}}}class K{constructor(t,e,s,i,n,o,r){this.source=t,this.firstFrame=e,this.origin=s,this.frameAdvance=i,this.numFrames=n,this.duration=o,this.loop=r}getPixelSize(){return new h.Z(this.firstFrame.w,this.firstFrame.y)}getRenderable(){return new O(this,this.loop)}getSprite(t){const e=new P.Z(this.firstFrame.x+t*this.frameAdvance.x,this.firstFrame.y+t*this.frameAdvance.y,this.firstFrame.w,this.firstFrame.h);return new L.Z(this.source,e,this.origin)}}class O{constructor(t,e,s){this.source=t,this.loop=e,this.overrideDuration=s,this.duration=null!=s?s:t.duration,this.currentTick=0}tick(){return this.currentTick++,this.currentTick===this.duration&&(this.loop&&(this.currentTick=0),!0)}getSprite(){const t=this.currentTick*this.source.numFrames/this.duration;return this.source.getSprite(Math.floor(t))}draw(t,e,s){this.getSprite().draw(t,e,s)}}class V{constructor(t,e){this.source=t,this.duration=e,this.currentTick=0}tick(){return this.currentTick>=this.duration?this.source.tick():(this.currentTick++,!1)}getSprite(){return this.source.getSprite()}draw(t,e,s){this.getSprite().draw(t,e,s)}}var z=s(9444);class N{constructor(t,e,s,i){this.entity=t,this.motion=e,this.target=s,this.duration=i,this.timer=new z.Yw(i)}tick(){return this.timer.tick()?(this.entity.position=this.target,!0):(this.entity.position=this.timer.sample(this.motion),!1)}draw(t){}}class j{constructor(t,e,s,i){this.renderable=t,this.bounds=e,this.fixedDuraiton=i,this.rotation=null!=s?s:0}tick(){return void 0!==this.fixedDuraiton?(this.fixedDuraiton--,-1===this.fixedDuraiton||(this.renderable.tick(),!1)):this.renderable.tick()}draw(t){this.renderable.draw(t,this.bounds,this.rotation)}}class X{constructor(t){this.steps=t}tick(){if(0===this.steps.length)return!0;for(;this.steps[0].tick();)if(this.steps.shift(),0===this.steps.length)return!0;return!1}draw(t){this.steps[0].draw(t)}}class G{constructor(t,e,s,i,n){this.renderable=t,this.size=e,this.fromPixel=s,this.toPixel=i,this.duration=n,this.angle=Math.atan2(i.y-s.y,i.x-s.x),this.time=0}tick(){return this.time++,this.time>=this.duration}draw(t){const e=h.Z.interpolate(this.fromPixel,this.toPixel,this.time/this.duration),s=new P.Z(e.x,e.y,this.size.x,this.size.y);this.renderable.draw(t,s,this.angle)}}function Y(t,e,s,i,n){const o=C(s),r=new G(t,t.getPixelSize(),h.Z.add(C(e),p),h.Z.add(o,p),i);if(null!==n){const t=new j(n.getRenderable(),new P.Z(o.x,o.y,l,c),0);return new X([r,t])}return r}class W{constructor(t,e,s,i,n,o,r,a,h){this.attacker=t,this.target=e,this.affectedTiles=s,this.damage=i,this.bumpAnimation=n,this.impactAnimation=o,this.projectile=r,this.ignoreEnemies=a,this.ignorePlayer=h,this.startPoint=t.position}static basicAttack(t,e,s){return new W(t,e.position,[e.position],s,!0,null,null)}static animationAttack(t,e,s,i,n){return new W(t,e.position,[e.position],s,null!=n&&n,i,null)}static projectileAttack(t,e,s,i,n){return new W(t,e.position,[e.position],s,!1,null!=n?n:null,i)}getAffectedTiles(t){return[{damage:this.damage,positions:this.affectedTiles,ignorePlayer:this.ignorePlayer,ignoreEnemies:this.ignoreEnemies}]}toAnimations(){let t=[];if(this.bumpAnimation&&t.push(new N(this.attacker,z.r7.linear(h.Z.interpolate,this.attacker.position,h.Z.interpolate(this.attacker.position,this.target,.5),this.attacker.position),this.attacker.position,10*q(h.Z.subtract(this.startPoint,this.target)))),this.projectile){const t=6*q(h.Z.subtract(this.startPoint,this.target));return[Y(this.projectile,this.startPoint,this.target,t,this.impactAnimation)]}if(this.impactAnimation){const e=C(this.target);t.push(new j(this.impactAnimation.getRenderable(),new P.Z(e.x,e.y,l,c)))}return t}applyExtraEffects(t){}}class ${constructor(t){this.position=t}static IsPlayer(t){return void 0!==t.primary}}class J extends ${draw(t){const e=C(this.position),s=new P.Z(e.x,e.y,l,c);this.getRenderable().draw(t,s,0)}}class Q extends J{}class tt extends Q{constructor(t){super(t),this.hp=this.maxHp=1,this.isFlying=!1,this.goldValue=1}static onAssetsLoaded(t){tt.sprite=t.getAsset("zombie").getRenderable()}getAttacks(t){const e=t.player.position;return 1===q(h.Z.subtract(e,this.position))?[W.basicAttack(this,t.player,1)]:[]}getMove(t,e,s){if(e.length>0)return this.position;const i=B(1).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(s.some((t=>t.equals(i[e]))))continue;if(!t.isValidMoveIgnoreEnemies(i[e],!1))continue;const r=q(h.Z.subtract(t.player.position,i[e]));r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e])}return 0===n.length?this.position:n[Math.floor(Math.random()*n.length)]}getRenderable(){return tt.sprite}}class et{constructor(t,e){this.source=t,this.delta=e}tick(){return this.source.tick()}draw(t,e,s){this.source.draw(t,new P.Z(e.x+this.delta.x*e.w,e.y+this.delta.y*e.h,e.w*this.delta.w,e.h*this.delta.h),s)}}class st{constructor(t,e){this.renderables=t,this.finishMode=null!=e?e:"any"}tick(){let t=!0,e=!1;for(let s=0;s<this.renderables.length;s++){const i=this.renderables[s].tick();t=t&&i,e=e||i}return"any"===this.finishMode?e:t}draw(t,e,s){for(let i=0;i<this.renderables.length;i++)this.renderables[i].draw(t,e,s)}}class it{constructor(t,e){this.typeId=t,this.isPathable=e}AfterPlayerTurn(t,e,s){return[]}AfterEnemyTurn(t,e,s){return[]}}class nt extends it{constructor(t,e,s,i,n){super(t,i),this.bg_renderable=new et(new L.Z(e.tiles.image,new P.Z(352,0,l,c)),new P.Z(0,.75,1,1)),!0===n&&(this.bg_renderable=new st([this.bg_renderable,new L.Z(e.tiles.image,new P.Z(0,0,l,c))])),this.renderable=new L.Z(e.tiles.image,new P.Z(s.x*l,s.y*c,l,c))}AfterWorldLoad(t,e){}draw(t,e,s){let i=C(s);this.bg_renderable.draw(t,new P.Z(i.x,i.y,l,c),0),this.renderable.draw(t,new P.Z(i.x,i.y,l,c),0)}}const ot=[{directions:[S.UpLeft,S.UpRight],tileCoords:new h.Z(0,0),tileSlice:new P.Z(0,0,1,.5)},{directions:[S.DownLeft,S.DownRight],tileCoords:new h.Z(0,0),tileSlice:new P.Z(0,.5,1,.5)},{directions:[S.Left,S.UpLeft],tileCoords:new h.Z(0,1),tileSlice:new P.Z(0,0,.5,.5)},{directions:[S.Right,S.UpRight],tileCoords:new h.Z(0,1),tileSlice:new P.Z(.5,0,.5,.5)},{directions:[S.Left,S.DownLeft],tileCoords:new h.Z(0,1),tileSlice:new P.Z(0,.5,.5,.5)},{directions:[S.Right,S.DownRight],tileCoords:new h.Z(0,1),tileSlice:new P.Z(.5,.5,.5,.5)}];function rt(t,e,s,i,n,o){const r=_.map(o),a=ot.map((o=>{const a=o.directions.reduceRight(((t,e)=>(t<<1)+(r[e]?1:0)),0),h=new P.Z((o.tileCoords.x+a+o.tileSlice.x+e)*i,(o.tileCoords.y+o.tileSlice.y+s)*n,o.tileSlice.w*i,o.tileSlice.h*n);return new et(new L.Z(t,h),o.tileSlice)}));return new st(a,"all")}class at{constructor(t,e){this.inner=t,this.delay=e}tick(){return 0===this.delay?this.inner.tick():(this.delay--,!1)}draw(t){if(0===this.delay)return this.inner.draw(t)}}class ht{constructor(t){this.steps=t}tick(){for(let t=this.steps.length-1;t>=0;t--)this.steps[t].tick()&&this.steps.splice(t,1);return 0===this.steps.length}draw(t){for(const e of this.steps)e.draw(t)}}class lt{constructor(t,e,s,i){this.point=t,this.infos=e,this.delayPerDist=s,this.animationSource=i}getAffectedTiles(t){return this.infos}toAnimations(t){const e=this.infos.reduce(((t,e)=>t.concat(e.positions)),[]);return[new ht(e.map((t=>{const e=q(h.Z.subtract(t,this.point)),s=this.delayPerDist*e,i=C(t);return new at(new j(this.animationSource.getRenderable(),new P.Z(i.x,i.y,l,c)),s)})))]}applyExtraEffects(t){}}class ct extends it{constructor(t){super(ct.TypeID,!1),this.assets=t,this.bg_renderable=new L.Z(t.tiles.image,new P.Z(352,0,l,c))}AfterEnemyTurn(t,e,s){const i=t.enemies.find((t=>t.position.x==e&&t.position.y==s));return void 0===i||i.isFlying?[]:[new lt(new h.Z(e,s),[{damage:999,positions:[new h.Z(e,s)]}],0,this.assets.getImpactAnimation(2))]}OnEntityStep(t){}AfterWorldLoad(t,e){this.lavaStatic=rt(this.assets.lavaLayers.image,0,0,l,c,(s=>{const i=h.Z.add(e,D.ToPoint(s));return!t.tiles.isInBounds(i.x,i.y)||t.tiles.get(e).typeId!==t.tiles.get(i).typeId})),this.lavaOverlay=rt(this.assets.lavaLayers.image,0,2,l,c,(s=>{const i=h.Z.add(e,D.ToPoint(s));return!t.tiles.isInBounds(i.x,i.y)||t.tiles.get(e).typeId!==t.tiles.get(i).typeId}))}draw(t,e,s){let i=C(s);this.bg_renderable.draw(t,new P.Z(i.x,i.y+24,l,c),0),this.lavaStatic.draw(t,new P.Z(i.x,i.y,l,c),0);let n=Math.round(1.5*Math.sin(e.renderTickNumber/15+s.x/2));this.lavaOverlay.draw(t,new P.Z(i.x,i.y+n,l,c),0)}}ct.TypeID=1;class dt extends Q{constructor(t){super(t),this.hp=this.maxHp=1,this.isFlying=!1,this.isAfraid=!1,this.goldValue=3}static onAssetsLoaded(t){dt.sprite=t.getAsset("archer"),dt.fearsprite=t.getAsset("archer_afraid"),dt.projectileSprite=t.getAsset("projectile_arrow"),dt.impactAnimation=t.getAsset("impact_point")}getAttacks(t){if(this.isAfraid)return[];const e=t.player.position,s=q(h.Z.subtract(e,this.position));if(s>1&&s<=5){let s=h.Z.subtract(e,this.position);if(0===s.x||0===s.y||s.x===-s.y){let i=new h.Z(Math.sign(s.x),Math.sign(s.y)),n=h.Z.add(i,this.position);for(;!n.equals(e);){if(void 0!==t.entityAt(n))return[];n=h.Z.add(i,n)}return[W.projectileAttack(this,t.player,1,dt.projectileSprite,dt.impactAnimation)]}}return[]}getMove(t,e,s){if(e.length>0)return this.isAfraid=!1,this.position;let i=h.Z.subtract(t.player.position,this.position);if(1===q(i)){this.isAfraid=!0;let e=h.Z.subtract(this.position,i);const n=t.tiles.isInBounds(e.x,e.y)?t.tiles.get(e):void 0;return void 0===n||e.equals(t.player.position)?this.position:n.isPathable||n.typeId===ct.TypeID?s.some((t=>t.equals(e)))?this.position:e:this.position}this.isAfraid=!1;const n=B(1).map((t=>h.Z.add(this.position,t)));n.push(this.position);let o=[],r=99,a=!1;for(let e=0;e<n.length;e++){if(!t.isValidMoveIgnoreEnemies(n[e],!1))continue;if(s.some((t=>t.equals(n[e]))))continue;const i=h.Z.subtract(t.player.position,n[e]),l=D.TryGetDirectionAndDistance(i),c=void 0!==l&&l.distance<=5,d=q(i);1!==d&&(c&&!a?(r=d,o=[n[e]],a=!0):d<r&&(!a||c)?(r=d,o=[n[e]]):d!==r||a&&!c||o.push(n[e]))}return 0===o.length?this.position:o[Math.floor(Math.random()*o.length)]}getRenderable(){return this.isAfraid?dt.fearsprite:dt.sprite}}class pt extends Q{constructor(t){super(t),this.hp=this.maxHp=1,this.isFlying=!1,this.goldValue=5}static onAssetsLoaded(t){pt.sprite=t.getAsset("mage"),pt.cooldownsprite=t.getAsset("mage_cooldown"),pt.projectileSprite=t.getAsset("projectile_fire"),pt.impactAnimation=t.getAsset("impact_fire")}getAttacks(t){if(this.attackOnCooldown)return[];const e=t.player.position;if(q(h.Z.subtract(e,this.position))<=3){let s=h.Z.subtract(e,this.position);if(0===s.x||0===s.y||s.x===-s.y){let i=new h.Z(Math.sign(s.x),Math.sign(s.y)),n=h.Z.add(i,this.position);for(;!n.equals(e);){if(void 0!==t.entityAt(n))return[];n=h.Z.add(i,n)}return this.attackOnCooldown=!0,[W.projectileAttack(this,t.player,1,pt.projectileSprite,pt.impactAnimation)]}}return[]}getMove(t,e,s){if(e.length>0)return this.position;if(this.attackOnCooldown)return this.attackOnCooldown=!1,this.position;const i=B(1).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(!t.isValidMoveIgnoreEnemies(i[e],!1))continue;if(s.some((t=>t.equals(i[e]))))continue;const r=q(h.Z.subtract(t.player.position,i[e]));r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e])}return 0===n.length?this.position:n[Math.floor(Math.random()*n.length)]}getRenderable(){return this.attackOnCooldown?pt.cooldownsprite:pt.sprite}}class ut{constructor(t,e,s,i,n,o){this.point=t,this.rings=e,this.delayPerRadius=s,this.animationSource=i,this.ignoreEnemies=n,this.ignorePlayer=o}getAffectedTiles(t){return this.rings.map((e=>({damage:e.damage,positions:B(e.radius).map((t=>h.Z.add(t,this.point))).filter((e=>t.tiles.isInBounds(e.x,e.y))),ignoreEnemies:this.ignoreEnemies,ignorePlayer:this.ignorePlayer})))}toAnimations(t){const e=[];for(const s of this.rings){const i=B(s.radius).map((t=>h.Z.add(t,this.point))).filter((e=>t.tiles.isInBounds(e.x,e.y)));e.push(new at(new ht(i.map((t=>new j(this.animationSource.getRenderable(),new P.Z(C(t).x,C(t).y,l,c))))),s.radius*this.delayPerRadius))}return[new ht(e)]}applyExtraEffects(t){}}class gt extends Q{constructor(t){super(t),this.hp=this.maxHp=12,this.isFlying=!1,this.turnSequenceIndex=Math.floor(Math.random()*gt.turnSequence.length),this.lastTurn=gt.turnSequence[0===this.turnSequenceIndex?gt.turnSequence.length-1:this.turnSequenceIndex-1],this.goldValue=15}static onAssetsLoaded(t){gt.renderable=new et(t.getAsset("giant"),new P.Z(0,-1,1,2)),gt.bigAttackPrepImage=new et(t.getAsset("giant_prep"),new P.Z(0,-1,1,2)),this.radialSmashAnimation=t.getAsset("impact_dirt")}getAttacks(t){switch(gt.turnSequence[this.turnSequenceIndex]){case"move":const e=t.player.position;return 1===q(h.Z.subtract(e,this.position))?[W.basicAttack(this,t.player,3)]:[];case"skip":case"smashPrep":default:return[];case"smash":return[new ut(this.position,[{radius:1,damage:3},{radius:2,damage:1}],8,gt.radialSmashAnimation,!0)]}}getMove(t,e,s){const i=gt.turnSequence[this.turnSequenceIndex];switch(this.turnSequenceIndex=(this.turnSequenceIndex+1)%gt.turnSequence.length,this.lastTurn=i,i){case"move":return e.length>0?this.position:this.internalGetMove(t,s);case"smash":return this.internalGetMove(t,s);default:return this.position}}internalGetMove(t,e){const s=B(1).map((t=>h.Z.add(this.position,t)));let i=[],n=99;for(let o=0;o<s.length;o++){if(!t.isValidMoveIgnoreEnemies(s[o],!1))continue;if(e.some((t=>t.equals(s[o]))))continue;const r=q(h.Z.subtract(t.player.position,s[o]));r<n?(n=r,i=[s[o]]):r===n&&i.push(s[o])}return 0===i.length?this.position:i[Math.floor(Math.random()*i.length)]}getRenderable(){return"smashPrep"===this.lastTurn?gt.bigAttackPrepImage:gt.renderable}}gt.turnSequence=["move","move","skip","move","smashPrep","smash"];class mt{constructor(t,e,s){this.source=t,this.offset=e,this.rotation=s}tick(){return this.source.tick()}draw(t,e,s){var i;this.source.draw(t,e.shift(this.offset.x,this.offset.y),s+(null!==(i=null==this?void 0:this.rotation)&&void 0!==i?i:0))}}class wt extends Q{constructor(t){super(t),this.hp=this.maxHp=3,this.isFlying=!0,this.prepFire=void 0,this.goldValue=5,this.randart=0}static onAssetsLoaded(t){wt.sprites=[t.getAsset("stone_eye_0").getRenderable(),t.getAsset("stone_eye_1").getRenderable(),t.getAsset("stone_eye_2").getRenderable()],wt.readySprite=t.getAsset("stone_eye_ready").getRenderable(),wt.impactAnimation=t.getAsset("impact_fire")}getAttacks(t){if(void 0!==this.prepFire){const e=[],s=D.ToPoint(this.prepFire);let i=h.Z.add(this.position,s);for(let n=0;n<5&&t.tiles.isInBounds(i.x,i.y);n++)e.push(i),i=h.Z.add(i,s);return this.prepFire=void 0,[new lt(this.position,[{damage:1,positions:e}],4,wt.impactAnimation)]}const e=t.player.position;if(q(h.Z.subtract(e,this.position))<=5){let t=h.Z.subtract(e,this.position);this.prepFire=D.FromPoint(t)}return[]}getMove(t,e,s){if(this.randart=Math.floor(Math.random()*wt.sprites.length),e.length>0||void 0!==this.prepFire)return this.position;const i=B(1).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(!t.isValidMoveIgnoreEnemies(i[e],!0))continue;if(s.some((t=>t.equals(i[e]))))continue;const r=q(h.Z.subtract(t.player.position,i[e]));1!==r&&(r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e]))}if(o>q(h.Z.subtract(t.player.position,this.position)))return this.position;if(0===n.length)return this.position;const r=n[Math.floor(Math.random()*n.length)],a=t.player.position;if(q(h.Z.subtract(a,r))<=5){let t=h.Z.subtract(a,r);this.prepFire=D.FromPoint(t)}return r}getRenderable(){return void 0!==this.prepFire?new mt(wt.readySprite,new h.Z(16,16),D.ToAngle(this.prepFire)):new mt(wt.sprites[this.randart],new h.Z(16,16))}}class ft{constructor(t,e){this.sprite=t,this.name=e}afterPlayerTurn(t,e,s,i){}afterEnemyTurn(t,e,s,i){}draw(t,e,s){const i=C(s);this.sprite.draw(t,new P.Z(i.x,i.y,l,c),0)}}class yt extends ft{constructor(){super(yt.sprite,"LifeGem"),this.isBroken=!1}static onAssetsLoaded(t){yt.sprite=t.getAsset("life_gem"),yt.brokenSprite=t.getAsset("life_gem_broken")}afterPlayerTurn(t,e,s,i){return e!==t.player.position.x||s!==t.player.position.y||this.isBroken||(this.isBroken=!0,t.brokenGems[t.currentFloor]=!0,t.player.hp+=1,t.player.maxHp+=1,this.sprite=yt.brokenSprite),i}}class vt extends ft{constructor(t,e){super(t?vt.brokenSprite:vt.sprite,"RunicLifeGem"),this.isBroken=t,this.index=e}static onAssetsLoaded(t){vt.sprite=t.getAsset("life_gem_runes"),vt.brokenSprite=t.getAsset("life_gem_broken_runes"),vt.flashAnimation=t.getAsset("life_gem_flash_animation")}afterPlayerTurn(t,e,s,i){this.hasFlashed||0!==t.enemies.length||this.isBroken||(this.sprite=new V(vt.flashAnimation.getRenderable(),12*this.index),this.hasFlashed=!0)}draw(t,e,s){this.sprite.tick()&&(this.sprite=this.isBroken?vt.brokenSprite:vt.sprite),super.draw(t,e,s)}}class At extends nt{constructor(t,e){super(At.TypeID,t,null!=e?e:new h.Z(0,0),!0,void 0!==e)}OnEntityStep(t){}}At.TypeID=0;class Zt{constructor(t,e){this._size=t,this.data=[];let s=2*t-1;for(let i=1-t;i<=t-1;i++){let t=[];for(let n=0;n<s-Math.abs(i);n++)t.push(e);this.data.push(t)}}size(){return this._size}get(t,e){const[s,i]=this.extractInputCoords(t,e);let[n,o]=this.toArrayCoords(s,i);return this.data[o][n]}set(t,e,s){const[i,n]=this.extractInputCoords(e,s),[o,r]=this.toArrayCoords(i,n);this.data[r][o]=t}extractInputCoords(t,e){return"number"==typeof t?[t,e]:void 0!==t.x?[t.x,t.y]:t}getRowLength(t){return 2*this._size-1-Math.abs(t)}isInBounds(t,e){if(e<=-this._size||e>=this._size)return!1;let[s,i]=this.getXRange(e);return t>=s&&t<i}getXRange(t){const e=this.getMinX(t);return[e,e+this.getRowLength(t)]}getMinX(t){const e=this._size-1+t;return-Math.min(e,this._size-1)}iterate(t){for(let e=1-this._size;e<this._size;e++){let[s,i]=this.getXRange(e);for(let n=s;n<i;n++)t(n,e,this.get(n,e))}}toArrayCoords(t,e){const s=this._size-1+e;return[t- -Math.min(s,this._size-1),s]}}function bt(t){if(null===t.parent)return[t.position];const e=bt(t.parent);return e.push(t.position),e}function kt(t,e,s,i,n){const o=function(t,e,s){const i=[],n=[{position:t,parent:null,cost:0}];for(;n.length>0;){const t=n.reduce(((t,e,s)=>e.cost<n[t].cost?s:t),0),o=n.splice(t,1)[0];if(i.push(o),e(o.position))return bt(o);for(const t of s(o.position)){const e={position:t.to,parent:o,cost:o.cost+t.cost};if(i.find((t=>t.position.equals(e.position))))continue;const s=n.findIndex((t=>t.position.equals(e.position)));-1===s?n.push(e):n[s].cost>e.cost&&(n[s]=e)}}return null}(m,i,(function(e){const i=[];for(const o of _){const r=h.Z.add(e,D.ToPoint(o));t.tiles.isInBounds(r.x,r.y)&&s(r,t.tiles.get(r))&&i.push({to:r,cost:t.tiles.get(r).isPathable?1-Math.random()*(null!=n?n:0):99})}return i}));for(const s of o)t.tiles.get(s).isPathable||t.tiles.set(new At(e),s)}function Mt(t,e,s){return kt(t,e,(e=>{var s;return"LifeGem"!==(null===(s=t.features.get(e))||void 0===s?void 0:s.name)}),(e=>{var s;return"Stairs"===(null===(s=t.features.get(e))||void 0===s?void 0:s.name)}),s)}class xt extends ft{constructor(){super(xt.sprite,"Shrine"),this.isUsed=!1}static onAssetsLoaded(t){xt.sprite=t.getAsset("shrine")}afterPlayerTurn(t,e,s,i){return e!==t.player.position.x||s!==t.player.position.y||this.isUsed||(this.isUsed=!0,t.player.hp=t.player.maxHp),i}}const It=["x","2","s","ArrowDown"],Tt=["w","8","ArrowUp"],St=["Enter"," "];class Rt{constructor(t,e){this.items=t,this.nextState=e,this.selectedItem=0;const s=t.length*Rt.shopItemSprite.height()+Rt.closeButton.height();this.displayOffset=new h.Z(208-Rt.shopItemSprite.width()/2,208-s/2),this.wrappedTexts=t.map((t=>void 0===t?[]:Lt(t.description,38)))}static onAssetsLoaded(t){Rt.assets=t,Rt.shopItemSprite=t.getAsset("shop_entry"),Rt.shopItemSelectedSprite=t.getAsset("shop_entry_selected"),Rt.shopItemNoMoney=t.getAsset("shop_entry_nomoney"),Rt.closeButton=t.getAsset("close_button"),Rt.closeButtonSelected=t.getAsset("close_button_selected")}init(t){this.selectedItem=0}tick(t,e,s){var i,n;if(It.some((t=>e.isKeyPressed(t)))&&(this.selectedItem=Math.min(this.selectedItem+1,this.items.length)),Tt.some((t=>e.isKeyPressed(t)))&&(this.selectedItem=Math.max(this.selectedItem-1,0)),St.some((t=>e.isKeyPressed(t)))){const e=this.getSelectedItem();if(void 0===e)return this.nextState(t);if(e.price<=t.gold){t.gold-=e.price,this.items[this.selectedItem]=void 0;const s=e.onBuy(t,t.player);void 0!==(null===(i=s)||void 0===i?void 0:i.replaceItem)&&(this.items[this.selectedItem]=null===(n=s)||void 0===n?void 0:n.replaceItem,this.wrappedTexts[this.selectedItem]=Lt(this.items[this.selectedItem].description,38))}}return this}getSelectedItem(){if(this.selectedItem!==this.items.length)return this.items[this.selectedItem]}draw(t,e){e.draw(t),t.globalAlpha=.5,t.fillStyle="black",t.fillRect(0,0,u,u),t.globalAlpha=1;for(let s=0;s<this.items.length;s++)this.drawShopItem(t,e,this.items[s],s===this.selectedItem,this.displayOffset.x,this.displayOffset.y+s*Rt.shopItemSprite.height(),this.wrappedTexts[s]);const s=this.selectedItem===this.items.length?Rt.closeButtonSelected:Rt.closeButton;s.draw(t,new P.Z(this.displayOffset.x+Rt.shopItemSprite.width()-s.width(),this.displayOffset.y+this.items.length*Rt.shopItemSprite.height(),s.width(),s.height()),0)}drawShopItem(t,e,s,i,n,o,r){const a=i?void 0===s||s.price<=e.gold?Rt.shopItemSelectedSprite:Rt.shopItemNoMoney:Rt.shopItemSprite;if(a.draw(t,new P.Z(n,o,a.width(),a.height()),0),void 0!==s){s.icon.draw(t,new P.Z(n+2,o+2,32,48),0),Rt.assets.drawString(t,new h.Z(n+38,o),s.name),Rt.assets.drawSmallString(t,new h.Z(n+223,o+3),"$"+s.price);for(let e=0;e<4&&e<r.length;e++)Rt.assets.drawSmallString(t,new h.Z(n+38,o+15+8*e),r[e])}}}function Lt(t,e){const s=t.split(" "),i=[];let n="";for(const t of s)n.length+t.length+1>e?(i.push(n),n=t+" "):n+=t+" ";return i.push(n),i}class Pt extends ft{constructor(t){super(Pt.sprite,"Shop"),this.items=t}static onAssetsLoaded(t){Pt.sprite=t.getAsset("shop")}afterPlayerTurn(t,e,s,i){if(e===t.player.position.x&&s===t.player.position.y)return t=>new Rt(this.items,i)}}class _t{constructor(t,e){this.weapon=t,this.price=e,this.name=t.name,this.description=t.description,this.icon=t.shopImage}onBuy(t,e){if("primary"===this.weapon.type){const t=e.primary;return e.primary=this.weapon,{replaceItem:new _t(t,0)}}{const t=e.secondary;return e.secondary=this.weapon,{replaceItem:new _t(t,0)}}}}class Dt{constructor(t,e){this.price=t,this.name="HP + 1",this.description="Heal to full health, and increase your max HP by 1",this.icon=e.getAsset("shop_heart+1_icon").getRenderable()}onBuy(t,e){e.maxHp++,e.hp=e.maxHp}}class Et{constructor(t,e,s){this.point=t,this.enemy=e,this.animationSource=s}getAffectedTiles(t){return[]}toAnimations(t){if(void 0!==this.animationSource){const t=C(this.point);return[new j(this.animationSource.getRenderable(),new P.Z(t.x,t.y,l,c))]}return[]}applyExtraEffects(t){void 0===t.entityAt(this.point)&&(this.enemy.position=this.point,t.enemies.push(this.enemy))}}class Ft extends Q{constructor(t){super(t),this.hp=this.maxHp=2,this.isFlying=!0,this.isExploding=!1,this.goldValue=0}static onAssetsLoaded(t){Ft.sprite=t.getAsset("blue_sphere").getRenderable(),Ft.explodingSprite=t.getAsset("blue_sphere_exploding").getRenderable(),Ft.impactAnimation=t.getAsset("impact_blue_magic")}getAttacks(t){return this.isExploding?(this.hp=0,[new ut(this.position,[{radius:1,damage:2}],8,Ft.impactAnimation,!0)]):(this.isExploding=!0,[])}getMove(t,e,s){return this.position}getRenderable(){return this.isExploding?Ft.explodingSprite:Ft.sprite}}class Ct extends Q{constructor(t){super(t),this.hp=this.maxHp=3,this.isFlying=!1,this.goldValue=5}static onAssetsLoaded(t){Ct.sprite=t.getAsset("blue_mage"),Ct.cooldownsprite=t.getAsset("blue_mage_cooldown"),Ct.spawnAnimation=t.getAsset("impact_blue_magic_backwards")}getAttacks(t){if(this.attackOnCooldown)return[];const e=t.player.position;if(q(h.Z.subtract(e,this.position))<=5){let s=B(1);s=s.map((t=>h.Z.add(e,t))).filter((e=>t.isValidMove(e,!0)));const i=s[Math.floor(Math.random()*s.length)];return this.attackOnCooldown=!0,[new Et(i,new Ft(i),Ct.spawnAnimation)]}return[]}getMove(t,e,s){if(e.length>0)return this.position;if(this.attackOnCooldown)return this.attackOnCooldown=!1,this.position;const i=B(1).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(!t.isValidMoveIgnoreEnemies(i[e],!1))continue;if(s.some((t=>t.equals(i[e]))))continue;const r=q(h.Z.subtract(t.player.position,i[e]));1!==r&&(r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e]))}return 0===n.length?this.position:n[Math.floor(Math.random()*n.length)]}getRenderable(){return this.attackOnCooldown?Ct.cooldownsprite:Ct.sprite}}const qt={1:new h.Z(0,6),3:new h.Z(0,7),5:new h.Z(0,8)},Bt={1:0,3:1,5:2};class Ht extends nt{constructor(t,e){super(Ht.TypeID,t,qt[e],!0,!1),this.state="wait",this.cooldown=0,this.assets=t,this.damage=e,this.state="wait",this.cooldown=Bt[e]}OnEntityStep(t){if("wait"===this.state){const t=qt[this.damage];super.renderable=new L.Z(this.assets.tiles.image,new P.Z((t.x+1)*l,t.y*c,l,c))}}AfterEnemyTurn(t,e,s){if("wait"===this.state&&void 0!==t.entityAt(new h.Z(e,s))&&(this.state="prep"),"prep"===this.state&&0===this.cooldown){this.state="fire";const i=qt[this.damage];if(super.renderable=new L.Z(this.assets.tiles.image,new P.Z((i.x+2)*l,i.y*c,l,c)),void 0!==t.entityAt(new h.Z(e,s)))return[new lt(new h.Z(e,s),[{damage:this.damage,positions:[new h.Z(e,s)]}],0,this.assets.getImpactAnimation(1))]}else"prep"===this.state&&this.cooldown--;return[]}}Ht.TypeID=5;class Ut extends Q{constructor(t){super(t),this.wasNextToPlayer=!1,this.hp=this.maxHp=1,this.isFlying=!1,this.goldValue=3}static onAssetsLoaded(t){Ut.sprite=t.getAsset("spider").getRenderable()}getAttacks(t){const e=t.player.position,s=q(h.Z.subtract(e,this.position));return 1===s?[W.basicAttack(this,t.player,1)]:2===s&&this.wasNextToPlayer?(this.wasNextToPlayer=!1,[W.basicAttack(this,t.player,1)]):[]}getMove(t,e,s){const i=B(2).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(s.some((t=>t.equals(i[e]))))continue;if(!t.isValidMoveIgnoreEnemies(i[e],!1))continue;const r=q(h.Z.subtract(t.player.position,i[e]));r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e])}const r=0===n.length?this.position:n[Math.floor(Math.random()*n.length)];return 1===q(h.Z.subtract(t.player.position,r))?this.wasNextToPlayer=!0:this.wasNextToPlayer=!1,r}getRenderable(){return Ut.sprite}}class Kt{constructor(t,e,s){this.type=t,"primary"===this.type?(this.sprite=new L.Z(e.weapons.image,new P.Z(s.x*l,s.y*c,16,c)),this.iconImage=new L.Z(e.weapons.image,new P.Z(s.x*l+16,s.y*c,16,c))):(this.sprite=new L.Z(e.weapons.image,new P.Z(s.x*l+16,s.y*c,16,c)),this.iconImage=new L.Z(e.weapons.image,new P.Z(s.x*l,s.y*c,16,c))),this.shopImage=new L.Z(e.weapons.image,new P.Z(s.x*l,48*s.y+64,l,48))}}function Ot(t){return void 0!==t.x}class Vt extends Kt{constructor(t,e,s,i,...n){super(t,e,s),this.beforeMove=i,this.attacks=n}getAttacks(t,e,s,i){const n=[],o=h.Z.subtract(i,s);for(const i of this.attacks){if(q(o)!==q(i.onMove))continue;const r=Vt.getRotation(o,i.onMove);if(void 0!==r)for(const o of i.pattern){const a=Ot(o)?[]:o.empty,l=h.Z.add(s,F(Ot(o)?o:o.target,r)),c=a.every((e=>void 0===t.entityAt(h.Z.add(s,F(e,r)))));if(0===a.length||c){const s=i.attack(t,e,l);void 0!==s&&n.push(s)}}}return n}enableAdditionalMoves(t,e){return[]}getBeforeMoveAttacks(t,e,s,i){return this.beforeMove?this.getAttacks(t,e,s,i):[]}getAfterMoveAttacks(t,e,s,i){return this.beforeMove?[]:this.getAttacks(t,e,s,i)}static getRotation(t,e){for(let s=0;s<6;s++){if(t.equals(e))return s;t=E(t)}}}class zt extends Vt{constructor(t){super("primary",t,new h.Z(0,0),!0,{onMove:new h.Z(1,0),pattern:[new h.Z(0,-1),new h.Z(1,-1),new h.Z(-1,1),new h.Z(0,1)],attack:(t,e,s)=>this.getAttack(t,e,s)}),this.impactAnimation=t.getImpactAnimation(0),this.name="Sword",this.description="A versatile weapon which strikes all adjacent enemies (except those directly behind you) when you move."}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.animationAttack(e,i,1,this.impactAnimation,!1)}}class Nt extends Vt{constructor(t){super("primary",t,new h.Z(1,0),!1,{onMove:new h.Z(1,0),pattern:[new h.Z(2,0)],attack:(t,e,s)=>this.getAttack(t,e,s)}),this.impactAnimation=t.getImpactAnimation(1),this.name="Spear",this.description="A primary weapon which strikes enemies two spaces away when you step towards them"}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.animationAttack(e,i,2,this.impactAnimation,!0)}}class jt extends Kt{constructor(t){super("primary",t,new h.Z(2,0)),this.impactAnimation=t.getImpactAnimation(0),this.name="Hammer",this.description="A primary weapon which allows you to attack an enemy by walking into them, dealing damage to them and adjacent enemies."}enableAdditionalMoves(t,e){const s=[];for(const i of B(1)){const n=h.Z.add(i,e.position);if(!t.tiles.isInBounds(n.x,n.y)||!t.tiles.get(n).isPathable)continue;const o=t.entityAt(n);void 0===o||$.IsPlayer(o)||s.push(n)}return s.map((t=>({dest:t,forceMove:e.position})))}getBeforeMoveAttacks(t,e,s,i){const n=t.entityAt(i);if(void 0===n||$.IsPlayer(n))return[];const o=h.Z.subtract(i,s);if(1!==q(o))return[];const r=Vt.getRotation(o,new h.Z(1,0)),a=[new h.Z(0,1),new h.Z(1,-1)].map((i=>{const n=h.Z.add(F(i,r),s),o=t.entityAt(n);if(void 0!==o)return W.animationAttack(e,o,2,this.impactAnimation,!1)})).filter((t=>void 0!==t));return[W.animationAttack(e,n,2,this.impactAnimation,!0),...a]}getAfterMoveAttacks(t,e,s,i){return[]}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.animationAttack(e,i,2,this.impactAnimation,!1)}}class Xt extends Vt{constructor(t){super("secondary",t,new h.Z(0,1),!0,{onMove:new h.Z(1,0),pattern:[new h.Z(1,-1),new h.Z(0,1)],attack:(t,e,s)=>this.getAttack(t,e,s)}),this.name="Dagger",this.description="A secondary weapon which attacks enemies forward-left and forward-right of you when you move."}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.basicAttack(e,i,1)}}class Gt extends Vt{constructor(t){super("secondary",t,new h.Z(1,1),!0,{onMove:new h.Z(1,0),pattern:[{empty:[new h.Z(1,-1)],target:new h.Z(2,-2)},{empty:[new h.Z(0,1)],target:new h.Z(0,2)}],attack:(t,e,s)=>this.getAttack(t,e,s)}),this.name="Kunai",this.projectile=t.getAsset("projectile_kunai"),this.description="A ranged secondary weapon which attacks enemies forward-left and forward-right of you two spaces away when you move"}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.projectileAttack(e,i,1,this.projectile)}}class Yt extends Vt{constructor(t){super("secondary",t,new h.Z(2,1),!0,{onMove:new h.Z(1,0),pattern:[new h.Z(-1,0),{empty:[new h.Z(-1,0)],target:new h.Z(-2,0)}],attack:(t,e,s)=>this.getAttack(t,e,s)}),this.name="Caltrops",this.projectile=t.getAsset("projectile_kunai"),this.description="A secondary weapon which attacks behind you up to 2 spaces away"}getAttack(t,e,s){const i=t.entityAt(s);if(void 0!==i&&!$.IsPlayer(i))return W.projectileAttack(e,i,1,this.projectile)}}const Wt=[{cost:50,generateItem:t=>new zt(t)},{cost:50,generateItem:t=>new Nt(t)},{cost:50,generateItem:t=>new jt(t)}],$t=[{cost:10,generateItem:t=>new Xt(t)},{cost:20,generateItem:t=>new Gt(t)},{cost:20,generateItem:t=>new Yt(t)}],Jt=[{cost:50,generateItem:t=>new zt(t)},{cost:50,generateItem:t=>new Nt(t)},{cost:50,generateItem:t=>new jt(t)}],Qt=[{cost:10,generateItem:t=>new Xt(t)},{cost:20,generateItem:t=>new Gt(t)}];class te{constructor(){this.isOpen=!1,this.name="Portal"}static onAssetsLoaded(t){let e;te.closedSprite=t.getAsset("portal_closed"),te.openSprites=[];for(let s=0;void 0!==(e=t.getAsset("portal_open_"+s,!0));s++)this.openSprites.push(e);te.openAnimation=t.getAsset("portal_open_anim").getRenderable()}afterEnemyTurn(t,e,s,i){}afterPlayerTurn(t,e,s,i){if(0!==t.enemies.length||this.isOpen||(this.isOpen=!0),e===t.player.position.x&&s===t.player.position.y&&this.isOpen)return()=>new ue}draw(t,e,s){const i=C(s),n=new P.Z(i.x,i.y,l,c);this.isOpen?(te.openAnimation.tick(),te.openAnimation.draw(t,n,0)):te.closedSprite.draw(t,n,0)}}class ee{static wrap(t,e){return(t%=e)<0&&(t+=e),t}}const se=[new h.Z(6,2),new h.Z(7,2),new h.Z(9,2),new h.Z(7,3),new h.Z(6,3),new h.Z(8,2)];class ie{generateMap(t,e,s){s.tiles=new Zt(7,new At(t)),s.features=new Zt(7,void 0);const i=B(2);for(var n=0;n<i.length;n++)s.tiles.set(new ct(t),i[n]);const o=B(3);for(n=0;n<o.length;n+=3)s.tiles.set(new ct(t),o[n]);const r=B(1).map((t=>h.Z.add(t,m)));for(let e=0;e<r.length;e++)s.tiles.set(new At(t,se[e]),r[e]);s.features.set(new me,2,-4)}}const ne=[{range:[0,1],gen:new ie},{range:[1,12],gen:new class{generateMap(t,e,s){s.tiles=new Zt(7,new At(t)),s.features=new Zt(7,void 0),s.enemies=[];let i=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),n=s.tiles.getMinX(i);this.genLava(t,s,new h.Z(n,i),Math.floor(12*Math.random())+4);let o=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),r=s.tiles.getXRange(o)[1]-1;this.genLava(t,s,new h.Z(r,o),Math.floor(12*Math.random())+4);const a=-6+Math.floor(3*Math.random()),[l,c]=s.tiles.getXRange(a),d=Math.floor(Math.random()*(c-l))+l;s.features.set(new me,d,a);const p=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),u=p[Math.floor(Math.random()*p.length)];if(s.features.set(new yt,u.x,u.y),e%3==0||11===e){const t=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),e=t[Math.floor(Math.random()*t.length)];s.features.set(new xt,e.x,e.y)}if(e%4==0||11===e){const e=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),i=e[Math.floor(Math.random()*e.length)],n=Wt[Math.floor(Math.random()*Wt.length)],o=$t[Math.floor(Math.random()*$t.length)],r=[new _t(n.generateItem(t),n.cost),new _t(o.generateItem(t),o.cost),new Dt(100,t)];s.features.set(new Pt(r),i.x,i.y)}Mt(s,t,1);let g=[];for(let t=-6;t<=1;t++){const[e,i]=s.tiles.getXRange(t);for(let n=e;n<i;n++)s.tiles.get(n,t).typeId===At.TypeID&&g.push(new h.Z(n,t))}for(let t=0;t<Math.min(12,e);t++){let t=Math.floor(Math.random()*g.length);const[e]=g.splice(t,1),i=Math.random()<.85?new tt(e):new Ut(e);s.enemies.push(i)}for(let t=0;t<Math.min(6,(e-3)/3);t++){let t=Math.floor(Math.random()*g.length);const[e]=g.splice(t,1),i=new dt(e);s.enemies.push(i)}for(let t=0;t<Math.min(3,(e-5)/3);t++){let t=Math.floor(Math.random()*g.length);const[e]=g.splice(t,1),i=Math.random()<.2?new wt(e):new pt(e);s.enemies.push(i)}for(const e of s.enemies)e.isFlying||kt(s,t,(t=>!0),(t=>t.equals(e.position)),.3);let m=[];s.tiles.iterate(((t,e,i)=>{i.typeId===At.TypeID&&void 0===s.features.get(t,e)&&m.push(new h.Z(t,e))}));for(let i=0;i<3+Math.min(3,(e-4)/4);i++){let e=m.splice(Math.floor(Math.random()*m.length),1)[0];s.tiles.set(new Ht(t,[1,3,5][Math.floor(3*Math.random())]),e.x,e.y)}}genLava(t,e,s,i){if(e.tiles.set(new ct(t),s),i<=1)return;const n=_.filter((t=>{const i=h.Z.add(s,D.ToPoint(t));return!(!e.tiles.isInBounds(i.x,i.y)||e.tiles.get(i).typeId!==At.TypeID||i.equals(m))}));if(0===n.length)return;const o=n[Math.floor(Math.random()*n.length)];this.genLava(t,e,h.Z.add(s,D.ToPoint(o)),i-1)}}},{range:[12,13],gen:new class{generateMap(t,e,s){s.tiles=new Zt(7,new At(t)),s.features=new Zt(7,void 0),s.features.set(new we,0,0);const i=B(4);for(let t=0;t<i.length/2-1;t++){const e=t+1,n=ee.wrap(2*(t-4),i.length);s.features.set(new vt(void 0!==s.brokenGems[e]&&s.brokenGems[e],e),i[n].x,i[n].y)}s.features.set(new te,-2,4),s.tiles.set(new ct(t),new h.Z(5,-1)),s.tiles.set(new ct(t),new h.Z(5,0)),s.tiles.set(new ct(t),new h.Z(4,1)),s.tiles.set(new ct(t),new h.Z(-4,-1)),s.tiles.set(new ct(t),new h.Z(-5,0)),s.tiles.set(new ct(t),new h.Z(-5,1)),s.enemies.push(new gt(new h.Z(0,0))),s.enemies.push(new wt(new h.Z(0,-2))),s.enemies.push(new wt(new h.Z(2,-2))),s.enemies.push(new wt(new h.Z(2,0))),s.enemies.push(new wt(new h.Z(-2,0)))}}},{range:[13,14],gen:new class{generateMap(t,e,s){s.tiles=new Zt(7,new At(t)),s.features=new Zt(7,void 0),s.regionId=1,s.enemies=[];let i=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),n=s.tiles.getMinX(i);this.genLava(t,s,new h.Z(n,i),Math.floor(12*Math.random())+4);let o=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),r=s.tiles.getXRange(o)[1]-1;this.genLava(t,s,new h.Z(r,o),Math.floor(12*Math.random())+4);const a=-6+Math.floor(3*Math.random()),[l,c]=s.tiles.getXRange(a),d=Math.floor(Math.random()*(c-l))+l;s.features.set(new me,d,a);const p=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),u=p[Math.floor(Math.random()*p.length)];s.features.set(new xt,u.x,u.y);const g=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),m=g[Math.floor(Math.random()*g.length)],w=[...Wt.map((e=>new _t(e.generateItem(t),e.cost))),...$t.map((e=>new _t(e.generateItem(t),e.cost))),new Dt(100,t)];s.features.set(new Pt(w),m.x,m.y),Mt(s,t,1);let f=[];for(let t=-6;t<=1;t++){const[e,i]=s.tiles.getXRange(t);for(let n=e;n<i;n++)s.tiles.get(n,t).typeId===At.TypeID&&f.push(new h.Z(n,t))}for(let t=0;t<3;t++){let t=Math.floor(Math.random()*f.length);const[e]=f.splice(t,1),i=new Ct(e);s.enemies.push(i)}for(const e of s.enemies)e.isFlying||kt(s,t,(t=>!0),(t=>t.equals(e.position)),.3);let y=[];s.tiles.iterate(((t,e,i)=>{i.typeId===At.TypeID&&void 0===s.features.get(t,e)&&y.push(new h.Z(t,e))}))}genLava(t,e,s,i){if(e.tiles.set(new ct(t),s),i<=1)return;const n=_.filter((t=>{const i=h.Z.add(s,D.ToPoint(t));return!(!e.tiles.isInBounds(i.x,i.y)||e.tiles.get(i).typeId!==At.TypeID||i.equals(m))}));if(0===n.length)return;const o=n[Math.floor(Math.random()*n.length)];this.genLava(t,e,h.Z.add(s,D.ToPoint(o)),i-1)}}},{range:[14,-1],gen:new class{generateMap(t,e,s){s.tiles=new Zt(7,new At(t)),s.features=new Zt(7,void 0),s.regionId=1,s.enemies=[];let i=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),n=s.tiles.getMinX(i);this.genLava(t,s,new h.Z(n,i),Math.floor(12*Math.random())+4);let o=Math.floor(5*Math.random())*(Math.random()>=.5?1:-1),r=s.tiles.getXRange(o)[1]-1;this.genLava(t,s,new h.Z(r,o),Math.floor(12*Math.random())+4);const a=-6+Math.floor(3*Math.random()),[l,c]=s.tiles.getXRange(a),d=Math.floor(Math.random()*(c-l))+l;if(s.features.set(new me,d,a),e%3==0||11===e){const t=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),e=t[Math.floor(Math.random()*t.length)];s.features.set(new xt,e.x,e.y)}if(e%4==0||11===e){const e=s.getCells(((t,e,s)=>e.typeId===At.TypeID&&void 0===s)),i=e[Math.floor(Math.random()*e.length)],n=Jt[Math.floor(Math.random()*Jt.length)],o=Qt[Math.floor(Math.random()*Qt.length)],r=[new _t(n.generateItem(t),n.cost),new _t(o.generateItem(t),o.cost),new Dt(100,t)];s.features.set(new Pt(r),i.x,i.y)}Mt(s,t,1);let p=[];for(let t=-6;t<=1;t++){const[e,i]=s.tiles.getXRange(t);for(let n=e;n<i;n++)s.tiles.get(n,t).typeId===At.TypeID&&p.push(new h.Z(n,t))}for(let t=0;t<Math.min(8,e);t++){let t=Math.floor(Math.random()*p.length);const[e]=p.splice(t,1),i=Math.random()<.85?new tt(e):new Ut(e);s.enemies.push(i)}for(const e of s.enemies)e.isFlying||kt(s,t,(t=>!0),(t=>t.equals(e.position)),.3);let u=[];s.tiles.iterate(((t,e,i)=>{i.typeId===At.TypeID&&void 0===s.features.get(t,e)&&u.push(new h.Z(t,e))}));for(let i=0;i<3+Math.min(3,(e-4)/4);i++){let e=u.splice(Math.floor(Math.random()*u.length),1)[0];s.tiles.set(new Ht(t,[1,3,5][Math.floor(3*Math.random())]),e.x,e.y)}}genLava(t,e,s,i){if(e.tiles.set(new ct(t),s),i<=1)return;const n=_.filter((t=>{const i=h.Z.add(s,D.ToPoint(t));return!(!e.tiles.isInBounds(i.x,i.y)||e.tiles.get(i).typeId!==At.TypeID||i.equals(m))}));if(0===n.length)return;const o=n[Math.floor(Math.random()*n.length)];this.genLava(t,e,h.Z.add(s,D.ToPoint(o)),i-1)}}}];class oe{constructor(t,e){this.animations=t,this.onFinish=e}init(t){}tick(t,e){for(let t=this.animations.length-1;t>=0;t--)this.animations[t].tick()&&this.animations.splice(t,1);return 0===this.animations.length?this.onFinish(t):this}draw(t,e){e.draw(t);for(const e of this.animations)e.draw(t)}}function re(t,e,s){for(const s of e){const e=s.getAffectedTiles(t);for(const s of e)for(const e of s.positions){const i=t.entityAt(e);void 0===i||$.IsPlayer(i)&&s.ignorePlayer||!$.IsPlayer(i)&&s.ignoreEnemies||(i.hp-=s.damage)}}for(const s of e)s.applyExtraEffects(t);let i=t.enemies.filter((t=>t.hp<=0)).map((t=>t.goldValue));return i.length>0&&(t.gold+=i.reduce(((t,e)=>t+e),0)*i.length),t.enemies=t.enemies.filter((t=>t.hp>0)),t.player.hp,s(t)}class ae{constructor(){this.chain=[]}static New(){return new ae}thenAnimate(t){return this.chain.push(((e,s)=>new oe(t,s))),this}thenResolve(t){return this.chain.push(((e,s)=>re(e,t,s))),this}thenAnimateAndResolve(t){return this.chain.push(((e,s)=>{const i=t.map((t=>new X(t.toAnimations(e))));return new oe(i,(()=>re(e,t,s)))})),this}then(t){return this.chain.push(t),this}finally(t){return this.chain.reduceRight(((t,e)=>s=>e(s,t)),t)}}function he(t,e,s){let i=[];e?t.tiles.iterate(((e,s,n)=>{const o=n.AfterPlayerTurn(t,e,s);void 0!==o&&o.length>0&&i.push(...o)})):t.tiles.iterate(((e,s,n)=>{const o=n.AfterEnemyTurn(t,e,s);void 0!==o&&o.length>0&&i.push(...o)}));var n=ae.New();return i.length>0&&(n=n.thenAnimateAndResolve(i)),n.finally((t=>function(t,e,s){return e?t.features.iterate(((e,i,n)=>{const o=null==n?void 0:n.afterPlayerTurn(t,e,i,s);void 0!==o&&(s=o)})):t.features.iterate(((e,i,n)=>{const o=null==n?void 0:n.afterEnemyTurn(t,e,i,s);void 0!==o&&(s=o)})),s(t)}(t,e,s)))(t)}function le(t,e,s,i){const n=t=>(i.equals(e)||t.tiles.get(i).OnEntityStep(t.player),0===t.enemies.length?he(t,!0,(t=>he(t,!1,(()=>new de)))):he(t,!0,(t=>function(t){const e=[];for(let s=0;s<t.enemies.length;s++)t.enemies[s].lastAttacks=t.enemies[s].getAttacks(t),e.push(t.enemies[s].lastAttacks);var s=ae.New();if(e.some((t=>t.length>0))){const i=e.map((e=>new X(e.map((e=>new ht(e.toAnimations(t)))))));s=s.thenAnimate(i).thenResolve(e.reduce(((t,e)=>t.concat(e)),[]))}return s.finally((t=>function(t){const e=t.enemies.map((t=>t.position)),s=[],i=[];for(let n=0;n<t.enemies.length;n++){const o=t.enemies[n].getMove(t,t.enemies[n].lastAttacks,e);if(o.equals(t.enemies[n].position))i.push(!1);else{s.push(new N(t.enemies[n],z.r7.linear(h.Z.interpolate,t.enemies[n].position,o),o,20));const r=e.findIndex((e=>e.equals(t.enemies[n].position)));e.splice(r,1,o),i.push(!0)}}return ae.New().thenAnimate(s).finally((t=>function(t,e){for(let s=0;s<e.length;s++)if(e[s]){const e=t.enemies[s];t.tiles.get(e.position).OnEntityStep(e)}return he(t,!1,(()=>new de))}(t,i)))(t)}(t)))(t)}(t)))),o=i=>{const o=[...t.player.primary.getAfterMoveAttacks(t,t.player,e,s),...t.player.secondary.getAfterMoveAttacks(t,t.player,e,s)];if(0===o.length)return n(i);const r=new X(o.map((t=>new ht(t.toAnimations()))));return new oe([r],(t=>re(t,o,n)))},r=t=>t.isValidMove(i,!1)?new oe([new N(t.player,z.r7.linear(h.Z.interpolate,e,i),i,0===t.enemies.length?2:10)],o):o(t);if(0===t.enemies.length)return r(t);if(t.enemies.length>0){const i=[...t.player.primary.getBeforeMoveAttacks(t,t.player,e,s),...t.player.secondary.getBeforeMoveAttacks(t,t.player,e,s)];if(0===i.length)return r(t);const n=new X(i.map((t=>new ht(t.toAnimations()))));return new oe([n],(t=>re(t,i,r)))}}const ce=[{key:"a",dir:S.Left},{key:"4",dir:S.Left},{key:"q",dir:S.UpLeft},{key:"7",dir:S.UpLeft},{key:"w",dir:S.UpRight},{key:"9",dir:S.UpRight},{key:"d",dir:S.Right},{key:"6",dir:S.Right},{key:"x",dir:S.DownRight},{key:"3",dir:S.DownRight},{key:"z",dir:S.DownLeft},{key:"1",dir:S.DownLeft},{key:"s",dir:6},{key:"5",dir:6}];class de{static onAssetsLoaded(t){this.cellHighlightSprite=t.getAsset("select_blue")}init(t){this.mouseTile=void 0}tick(t,e,s){const i=this.tryGetDirection(t,e,s);if(void 0!==i){const e=6===i?t.player.position:h.Z.add(t.player.position,D.ToPoint(i)),s=[...t.player.primary.enableAdditionalMoves(t,t.player),...t.player.secondary.enableAdditionalMoves(t,t.player)];if(!t.isValidMoveIgnorePlayer(e,!1)){const i=s.find((t=>t.dest.equals(e)));return void 0!==i?le(t,t.player.position,e,i.forceMove):this}return le(t,t.player.position,e,e)}return this}tryGetDirection(t,e,s){for(let t=0;t<ce.length;t++)if(e.isKeyPressed(ce[t].key))return ce[t].dir;const i=s.tryGetClick(0);if(void 0!==i&&(this.mouseTile=function(t){const e=Math.floor((t.y-g.y)/d.y),s=Math.floor((t.x-g.x-d.x*e)/32);return new h.Z(s,e)}(xe.scaleHelper.ScreenToPixel(i.position)),q(h.Z.subtract(this.mouseTile,t.player.position))<=1))return this.mouseTile.equals(t.player.position)?6:D.FromPoint(h.Z.subtract(this.mouseTile,t.player.position))}draw(t,e){if(e.draw(t),void 0!==this.mouseTile){const e=C(this.mouseTile);de.cellHighlightSprite.draw(t,new P.Z(e.x,e.y,l,c),0)}}}class pe{constructor(){this.animationTime=0}init(t){}tick(t,e){return this.animationTime++,this.animationTime>=60?new de:this}draw(t,e){e.draw(t),t.fillStyle="#000000",this.animationTime<=60&&(t.globalAlpha=1-this.animationTime/60,t.fillRect(0,0,u,u),t.globalAlpha=1),e.player.draw(t)}}class ue{constructor(){this.time=0}init(t){}tick(t,e){return this.time++,this.time>=30?new ge:this}draw(t,e){e.draw(t),t.fillStyle="#000000",t.globalAlpha=this.time/30,t.fillRect(0,0,u,u),t.globalAlpha=1,e.player.draw(t)}}class ge{constructor(){this.time=0}init(t){const e=t.currentFloor+1,s=ne.filter((t=>e>=t.range[0]&&(-1===t.range[1]||e<t.range[1])))[0].gen;this.playerStartPoint=t.player.position,t.changeFloor(e,s)}tick(t,e){return this.time++,this.time>=30?(t.player.position=m.clone(),new pe):this}draw(t,e){const s=this.time/30,i=h.Z.interpolate(this.playerStartPoint,m,s);e.player.position=i,e.player.draw(t)}}class me extends ft{constructor(){super(me.sprite,"Stairs")}static onAssetsLoaded(t){me.sprite=t.getAsset("down_stairs")}afterPlayerTurn(t,e,s,i){if(e===t.player.position.x&&s===t.player.position.y)return()=>new ue}}class we extends ft{constructor(){super(we.sprite,"LockedStairs"),this.hasPlayedAnimation=this.isPlayingAnimation=!1}static onAssetsLoaded(t){we.sprite=t.getAsset("down_stairs_locked"),we.unlockAnimation=t.getAsset("down_stairs_unlock_animation")}afterPlayerTurn(t,e,s,i){if(0!==t.enemies.length||0!==Object.keys(t.brokenGems).length||this.isPlayingAnimation){if(this.hasPlayedAnimation&&e===t.player.position.x&&s===t.player.position.y)return()=>new ue}else this.isPlayingAnimation=!0,this.sprite=we.unlockAnimation.getRenderable()}draw(t,e,s){this.sprite.tick()&&(this.hasPlayedAnimation=!0,this.sprite=me.sprite),super.draw(t,e,s)}}class fe extends Q{constructor(t){super(t),this.hp=this.maxHp=5,this.isFlying=!0,this.isReadyToFire=!1,this.goldValue=8}static onAssetsLoaded(t){fe.sprite=t.getAsset("stone_disc").getRenderable(),fe.readySprite=t.getAsset("stone_disc_ready").getRenderable(),fe.impactAnimation=t.getAsset("impact_fire")}getAttacks(t){if(this.isReadyToFire){const e=[];for(const s of _){const i=D.ToPoint(s);let n=h.Z.add(this.position,i);for(let s=0;s<5&&t.tiles.isInBounds(n.x,n.y);s++)e.push(n),n=h.Z.add(n,i)}return this.isReadyToFire=!1,[new lt(this.position,[{damage:1,positions:e}],4,fe.impactAnimation)]}const e=t.player.position;return q(h.Z.subtract(e,this.position))<=5&&void 0!==D.FromPoint(h.Z.subtract(e,this.position))&&(this.isReadyToFire=!0),[]}getMove(t,e,s){if(e.length>0||this.isReadyToFire)return this.position;const i=B(1).map((t=>h.Z.add(this.position,t)));let n=[],o=99;for(let e=0;e<i.length;e++){if(!t.isValidMoveIgnoreEnemies(i[e],!0))continue;if(s.some((t=>t.equals(i[e]))))continue;const r=q(h.Z.subtract(t.player.position,i[e]));1!==r&&(r<o?(o=r,n=[i[e]]):r===o&&n.push(i[e]))}return o>q(h.Z.subtract(t.player.position,this.position))||0===n.length?this.position:n[Math.floor(Math.random()*n.length)]}getRenderable(){return this.isReadyToFire?fe.readySprite:fe.sprite}}class ye{constructor(t){this.assetFilesByName={},this.tiles=new w.V(32,32,f,t.registerAssetLoadCallback()),this.enemies=new w.V(32,32,A,t.registerAssetLoadCallback()),this.features=new w.V(32,32,y,t.registerAssetLoadCallback()),this.floor_and_digits=new R.Z(v,t.registerAssetLoadCallback()),this.hpImage=new R.Z(Z,t.registerAssetLoadCallback()),this.impacts=new R.Z(b,t.registerAssetLoadCallback()),this.lavaLayers=new w.V(32,32,k,t.registerAssetLoadCallback()),this.weapons=new R.Z(x,t.registerAssetLoadCallback()),this.shopUI=new R.Z(M,t.registerAssetLoadCallback()),this.ascii=new w.V(8,16,I.Z,t.registerAssetLoadCallback()),this.asciiSmall=new w.V(6,8,T,t.registerAssetLoadCallback());const e=t.registerAssetLoadCallback();s.e(749).then(s.t.bind(s,7128,19)).then((t=>{console.log(t.default),this.assetSheet=t.default,e()}))}getImpactAnimation(t){return new K(this.impacts.image,new P.Z(0,32*t,32,32),new h.Z(0,0),new h.Z(32,0),8,16,!1)}onLoadFinished(){this.hpRenderer=new U(this.hpImage),this.assetFilesByName={hoplite_tiles:this.tiles.image,hoplite_impacts:this.impacts.image,floor_and_digits:this.floor_and_digits.image,hp:this.hpImage.image,lava_layers:this.lavaLayers.image,features:this.features.image,enemies:this.enemies.image,weapons:this.weapons.image,shop_ui:this.shopUI.image},de.onAssetsLoaded(this),Rt.onAssetsLoaded(this),tt.onAssetsLoaded(this),dt.onAssetsLoaded(this),pt.onAssetsLoaded(this),gt.onAssetsLoaded(this),wt.onAssetsLoaded(this),Ut.onAssetsLoaded(this),fe.onAssetsLoaded(this),Ct.onAssetsLoaded(this),Ft.onAssetsLoaded(this),yt.onAssetsLoaded(this),me.onAssetsLoaded(this),xt.onAssetsLoaded(this),vt.onAssetsLoaded(this),we.onAssetsLoaded(this),te.onAssetsLoaded(this),Pt.onAssetsLoaded(this)}getAsset(t,e){var s,i;const n=this.assetSheet[t];if(void 0!==n){var o=this.assetFilesByName[n.file];if(void 0===o)return void(e||console.error("Asset "+t+" references missing file: "+n.file));const r="tiles"===(null!==(s=n.units)&&void 0!==s?s:"tiles")?l:1,a=n.pos[0],c=n.pos[1],d=void 0===n.size?1:n.size[0],p=void 0===n.size?1:n.size[1],u=void 0===n.origin?0:n.origin[0],g=void 0===n.origin?0:n.origin[1];if(void 0!==n.numFrames){const t=void 0===n.advance?1:n.advance[0],e=void 0===n.advance?0:n.advance[1];return new K(o,new P.Z(a*r,c*r,d*r,p*r),new h.Z(u,g),new h.Z(t*d*r,e*p*r),n.numFrames,n.duration,void 0!==n.loop&&n.loop)}{const t="tiles"===(null!==(i=n.units)&&void 0!==i?i:"tiles")?l:1,e=n.pos[0],s=n.pos[1],r=void 0===n.size?1:n.size[0],a=void 0===n.size?1:n.size[1];return new L.Z(o,new P.Z(e*t,s*t,r*t,a*t),new h.Z(u,g))}}e||console.error("Asset not found: "+t)}getDigitSprite(t,e){return new L.Z(this.floor_and_digits.image,new P.Z(41+7*t,13*(null!=e?e:0),7,13))}drawNumber(t,e,s,i){const n=s.toString().split("").map((t=>parseInt(t)));for(var o=0;o<n.length;o++)this.getDigitSprite(n[o],i).draw(t,new P.Z(e.x+7*o,e.y,7,13),0)}drawString(t,e,s){for(var i=0;i<s.length;i++){const n=s.charCodeAt(i);this.ascii.getSprite(n%16,Math.floor(n/16),8,16).draw(t,new P.Z(e.x+8*i,e.y,8,16),0)}}drawSmallString(t,e,s){for(var i=0;i<s.length;i++){const n=s.charCodeAt(i);this.asciiSmall.getSprite(n%16,Math.floor(n/16),6,8).draw(t,new P.Z(e.x+6*i,e.y,6,8),0)}}}class ve extends ${constructor(t,e){super(e),this.hpRenderer=t.hpRenderer,this.maxHp=this.hp=3,this.primary=new zt(t),this.secondary=new Xt(t),this.renderable=t.getAsset("player")}draw(t){const e=C(this.position),s=new P.Z(e.x,e.y,l,c);this.renderable.draw(t,s,0),this.primary.sprite.draw(t,new P.Z(s.x,s.y,s.w/2,s.h),0),this.secondary.sprite.draw(t,new P.Z(s.x+s.w/2,s.y,s.w/2,s.h),0),this.hpRenderer.draw(t,this.position,this.hp,this.maxHp)}}const Ae=[{region:0,from:0,to:13},{region:1,from:13,to:-1}];class Ze{constructor(t,e,s,i){this.assets=t,this.enemies=[],this.brokenGems={},this.changeFloor(s,i),this.regionId=0,this.player=new ve(t,m),this.gold=0,this.renderTickNumber=0}entityAt(t){return[this.player,...this.enemies].find((e=>e.position.equals(t)))}isValidMove(t,e){return!(!this.tiles.isInBounds(t.x,t.y)||!this.tiles.get(t).isPathable&&!e||t.equals(this.player.position)||this.enemies.some((e=>e.position.equals(t))))}isValidMoveIgnorePlayer(t,e){return!(!this.tiles.isInBounds(t.x,t.y)||!this.tiles.get(t).isPathable&&!e||this.enemies.some((e=>e.position.equals(t))))}isValidMoveIgnoreEnemies(t,e){return!(!this.tiles.isInBounds(t.x,t.y)||!this.tiles.get(t).isPathable&&!e||t.equals(this.player.position))}changeFloor(t,e){this.enemies=[],e.generateMap(this.assets,t,this),this.currentFloor=t,this.setCorrectRegion(),this.tiles.iterate(((t,e,s)=>{s.AfterWorldLoad(this,new h.Z(t,e))}))}setCorrectRegion(){for(const t of Ae)if(this.currentFloor>=t.from&&(this.currentFloor<t.to||-1===t.to))return this.regionId=t.region,void(this.displayFloor=this.currentFloor-t.from+1)}getCells(t){let e=[];return this.tiles.iterate(((s,i,n)=>{const o=new h.Z(s,i),r=this.features.get(o);t(o,n,r)&&e.push(o)})),e}draw(t,e){new L.Z(this.assets.floor_and_digits.image,new P.Z(0,13*this.regionId,41,13)).draw(t,new P.Z(0,0,41,13),0),this.assets.drawNumber(t,new h.Z(42,0),this.displayFloor,this.regionId),new L.Z(this.assets.floor_and_digits.image,new P.Z(0,39,41,13)).draw(t,new P.Z(0,14,41,13),0),this.assets.drawNumber(t,new h.Z(42,14),this.gold,3),this.tiles.iterate(((e,s,i)=>{i.draw(t,this,new h.Z(e,s))})),this.features.iterate(((e,s,i)=>{null==i||i.draw(t,this,new h.Z(e,s))})),[this.player,...this.enemies].forEach((s=>{e&&e.includes(s)||(s.draw(t),s.hp!=s.maxHp&&this.assets.hpRenderer.draw(t,s.position,s.hp,s.maxHp))})),this.renderTickNumber++}}class be{constructor(){this.animationTime=0}init(t){}tick(t,e){return this.animationTime++,this.animationTime>=120?new pe:this}draw(t,e){e.player.draw(t),t.fillStyle="#000000",this.animationTime<=120&&(t.globalAlpha=1-this.animationTime/120,t.fillRect(0,0,u,u),t.globalAlpha=1)}}class ke{constructor(t,e=5){this.attachedElement=t,this.dragThreshold=e,this.clickEvents={},this.outputEvents=[],t.addEventListener("mouseenter",(t=>this.onMouseEnter(t))),t.addEventListener("mousemove",(t=>this.onMouseMove(t))),t.addEventListener("mouseleave",(t=>this.onMouseLeave(t))),t.addEventListener("mousedown",(t=>this.onMouseDown(t))),t.addEventListener("mouseup",(t=>this.onMouseUp(t)))}onMouseEnter(t){this.position=new h.Z(t.offsetX,t.offsetY)}onMouseLeave(t){this.position=void 0}onMouseMove(t){this.position=new h.Z(t.offsetX,t.offsetY);for(const e in this.clickEvents){const s=this.clickEvents[e];(s.isDrag||h.Z.subtract(this.position,s.at).lengthSq()>=this.dragThreshold*this.dragThreshold)&&(this.clickEvents[e].isDrag=!0,this.outputEvents.push({button:t.button,startPosition:s.at,endPosition:this.position,eventType:"drag"}))}}onMouseDown(t){const e=new h.Z(t.offsetX,t.offsetY);this.clickEvents[t.button]={at:e,isDrag:!1},this.outputEvents.push({button:t.button,position:e,eventType:"down"})}onMouseUp(t){this.position=new h.Z(t.offsetX,t.offsetY);const e=this.clickEvents[t.button];e&&(this.outputEvents.push({button:t.button,position:e.at,eventType:"up"}),e.isDrag?this.outputEvents.push({button:t.button,startPosition:e.at,endPosition:this.position,eventType:"drag_end"}):this.outputEvents.push({button:t.button,position:e.at,eventType:"click"})),delete this.clickEvents[t.button]}update(){const t=this.outputEvents;return this.outputEvents=[],t}}class Me{constructor(t){this.watcher=new ke(t),this.updates=[]}update(){this.updates=this.watcher.update()}position(){return this.watcher.position}isButtonDown(t){return void 0!==this.watcher.clickEvents[t]}isButtonUp(t){return!this.isButtonDown(t)}isButtonPressed(t){return this.updates.some((e=>e.button===t&&"down"===e.eventType))}isButtonReleased(t){return this.updates.some((e=>e.button===t&&"up"===e.eventType))}isButtonClicked(t){return this.updates.some((e=>e.button===t&&"click"===e.eventType))}isButtonDragEnd(t){return this.updates.some((e=>e.button===t&&"drag_end"===e.eventType))}tryGetDrag(t){const e=this.updates.filter((e=>e.button===t&&("drag"===e.eventType||"drag_end"===e.eventType)));if(0!==e.length)return e[0]}tryGetClick(t){const e=this.updates.filter((e=>e.button===t&&"click"===e.eventType));if(0!==e.length)return e[0]}}class xe{static run(){let t;const e=new n.Z,s=new ye(e);let i,h=new be;function l(){xe.scaleHelper.TryRescale(),(0,o.Ci)(t),xe.mouse.update();const e=h.tick(i,xe.keys,xe.mouse);t.clearRect(0,0,u,u),t.fillStyle="#000000",t.fillRect(0,0,u,u),h.draw(t,i),e!==h&&(h=e,e.init(i)),xe.keys.update(),requestAnimationFrame((()=>l()))}return xe.keys=new a.Z(document.body),e.onAllFinished((function(){s.onLoadFinished();const e=document.getElementById("mainCanvas");t=e.getContext("2d"),xe.mouse=new Me(e),xe.scaleHelper=new r.Z(e,t,u,u,!0,(()=>{})),i=new Ze(s,7,0,new ie),(0,o.Ci)(t),l()})),()=>xe.scaleHelper.Detatch()}}function Ie(){return i.useEffect((()=>xe.run())),i.createElement("div",{className:"rpgt rpgt_body full_body center",style:{background:"black"}},i.createElement("canvas",{id:"mainCanvas"}))}}}]);
//# sourceMappingURL=hoplite.bundle.js.map