"use strict";(self.webpackChunktrading_game=self.webpackChunktrading_game||[]).push([[204],{7475:(i,t,o)=>{o.d(t,{L:()=>e});var n=o(8785);class e{constructor(i,t,o,e,s){this.atlas=i,this.sourceOffset=t,this.sourceSize=o,this.numFrames=e,this.origin=null!=s?s:new n.Z(0,0)}static FromJson(i,t){return new e(i,new n.Z(t.sourceOffset[0],t.sourceOffset[1]),new n.Z(t.frameSize[0],t.frameSize[1]),t.numFrames,void 0===t.origin?void 0:new n.Z(t.origin[0],t.origin[1]))}draw(i,t,o,n,e){i.save(),i.translate(t.x,t.y),void 0!==e&&i.rotate(e),i.scale(o.x,o.y),i.translate(-this.origin.x,-this.origin.y),i.drawImage(this.atlas.image,this.sourceOffset.x+n*this.sourceSize.x,this.sourceOffset.y,this.sourceSize.x,this.sourceSize.y,0,0,1,1),i.restore()}play(i,t){var o;return void 0!==i.animation?new s(this,i.maxTime,null!==(o=i.loop)&&void 0!==o&&o):new s(this,i,null!=t&&t)}}class s{constructor(i,t,o){this.source=i,this.maxTime=t,this.loop=o,this.currentTime=0}tick(){return this.currentTime++,!(this.currentTime<this.maxTime||(this.loop&&(this.currentTime=0),0))}draw(i,t,o,n){const e=Math.floor(this.currentTime*this.source.numFrames/this.maxTime);this.source.draw(i,t,o,e,n)}}},275:(i,t,o)=>{o.d(t,{R:()=>s,Z:()=>r});var n=o(8785),e=o(7475);class s{constructor(i,t){this.onload=t,this.image=document.createElement("img"),this.image.src=i,this.image.addEventListener("load",(()=>this.loadFinished()))}loadFinished(){this.onload()}getSprite(i,t,o,n){return new r(this,i,t,o,n)}getAnimation(i,t,o,n){return new e.L(this,i,t,n,o)}}class r{constructor(i,t,o,e,s){this.atlas=i,this.sourceOffset=t,this.sourceSize=o,this.origin=null!=e?e:new n.Z(0,0),this.sourceRotation=null!=s?s:0}draw(i,t,o,n){i.save(),i.translate(t.x,t.y),i.rotate((null!=n?n:0)+this.sourceRotation),i.scale(o.x,o.y),i.translate(-this.origin.x,-this.origin.y),i.drawImage(this.atlas.image,this.sourceOffset.x,this.sourceOffset.y,this.sourceSize.x,this.sourceSize.y,0,0,1,1),i.restore()}}},2909:(i,t,o)=>{o.d(t,{Z:()=>e});const n=2*Math.PI;class e{static normalize(i){return(i%=n)<0&&(i+=n),i}static relativeNormalize(i){return(i%=n)>Math.PI?i-=n:i<-Math.PI&&(i+=n),i}static relativeAngle(i,t){return e.relativeNormalize(i-t)}}},8785:(i,t,o)=>{o.d(t,{Z:()=>n});class n{constructor(i,t){this.x=i,this.y=t}static zero(){return new n(0,0)}static fromAngle(i,t){return new n(Math.cos(i)*(null!=t?t:1),Math.sin(i)*(null!=t?t:1))}lengthSq(){return n.dot(this,this)}length(){return Math.sqrt(this.lengthSq())}clone(){return new n(this.x,this.y)}negate(){return new n(-this.x,-this.y)}negateInPlace(){return this.x=-this.x,this.y=-this.y,this}static dot(i,t){return i.x*t.x+i.y*t.y}dotWith(i){return n.dot(this,i)}normalize(){let i=this.length();return n.multiply(this,1/i)}direction(){return Math.atan2(this.y,this.x)}truncate(){return new n(Math.trunc(this.x),Math.trunc(this.y))}addWith(i,t){const{x:o,y:n}=e(i,t);return this.x+=o,this.y+=n,this}multWith(i,t){const{x:o,y:n}=function(i,t){return void 0===t?void 0!==i.x?{x:i.x,y:i.y}:{x:i,y:i}:{x:i,y:t}}(i,t);return this.x*=o,this.y*=n,this}subtractWith(i,t){const{x:o,y:n}=e(i,t);return this.x-=o,this.y-=n,this}divideWith(i,t){const{x:o,y:n}=e(i,t);return this.x/=o,this.y/=n,this}equals(i){return this.x===i.x&&this.y===i.y}static add(i,t,o){const{x:s,y:r}=e(t,o);return new n(i.x+s,i.y+r)}static subtract(i,t,o){const{x:s,y:r}=e(t,o);return new n(i.x-s,i.y-r)}static multiply(i,t,o){return void 0!==o?new n(i.x*t,i.y*o):void 0!==t.x?new n(i.x*t.x,i.y*t.y):new n(i.x*t,i.y*t)}static interpolate(i,t,o){return new n(i.x+(t.x-i.x)*o,i.y+(t.y-i.y)*o)}static componentMin(i,t){return i.x<=t.x&&i.y<=t.y?i:t.x<=i.x&&t.y<=i.y?t:new n(Math.min(i.x,t.x),Math.min(i.y,t.y))}static componentMax(i,t){return i.x>=t.x&&i.y>=t.y?i:t.x>=i.x&&t.y>=i.y?t:new n(Math.max(i.x,t.x),Math.max(i.y,t.y))}static Bezier(i,t){return 1===i.length?i[0]:2===i.length?n.add(n.multiply(i[1],t),n.multiply(i[0],1-t)):n.add(n.multiply(n.Bezier(i.slice(1),t),t),n.multiply(n.Bezier(i.slice(0,i.length-1),t),1-t))}rotate(i){const t=Math.atan2(this.y,this.x),o=this.length();return n.fromAngle(t+i,o)}}function e(i,t){return void 0===t?{x:i.x,y:i.y}:{x:i,y:t}}},9934:(i,t,o)=>{o.d(t,{Z:()=>n});class n{static Int(i,t){const o=Math.random();return void 0===i&&void 0===t?Math.floor(o*Number.MAX_SAFE_INTEGER):void 0===t?Math.floor(o*i):i+Math.floor(o*(t-i))}static Float(i,t){const o=Math.random();return void 0===i&&void 0===t?o:void 0===t?o*i:i+o*(t-i)}}},1204:(i,t,o)=>{o.r(t),o.d(t,{default:()=>si});var n,e=o(3804),s=o(127),r=o(5901),a=o(7584),c=o(8785);!function(i){i[i.Red=0]="Red",i[i.Green=1]="Green",i[i.Yellow=2]="Yellow",i[i.Blue=3]="Blue",i[i.Gray_Bounce=-1]="Gray_Bounce",i[i.Gray_TurnLeft=-2]="Gray_TurnLeft",i[i.Gray_TurnRight=-3]="Gray_TurnRight"}(n||(n={}));const l=n,h=[n.Red,n.Green,n.Yellow,n.Blue,n.Gray_Bounce,n.Gray_TurnLeft,n.Gray_TurnRight];var d;!function(i){i[i.RR=1]="RR",i[i.RB=2]="RB",i[i.BR=2]="BR",i[i.RL=4]="RL",i[i.LR=4]="LR",i[i.RT=8]="RT",i[i.TR=8]="TR",i[i.BB=16]="BB",i[i.BL=32]="BL",i[i.LB=32]="LB",i[i.BT=64]="BT",i[i.TB=64]="TB",i[i.LL=128]="LL",i[i.LT=256]="LT",i[i.TL=256]="TL",i[i.TT=512]="TT"}(d||(d={}));const p=d;var u;!function(i){i[i.Right=0]="Right",i[i.Bottom=1]="Bottom",i[i.Left=2]="Left",i[i.Top=3]="Top"}(u||(u={}));const x=[[p.RR,p.RB,p.RL,p.RT],[p.BR,p.BB,p.BL,p.BT],[p.LR,p.LB,p.LL,p.LT],[p.TR,p.TB,p.TL,p.TT]],y=u,f=Math.PI/2;class g{static EquivalentPosition(i){if(void 0!==i)return{position:c.Z.add(i.position,g.AnchorToTileMove(i.anchor)),anchor:g.ReverseDirection(i.anchor)}}static AnchorToIndex(i){return i}static AnchorToTileMove(i){switch(i){case u.Right:return new c.Z(1,0);case u.Bottom:return new c.Z(0,1);case u.Left:return new c.Z(-1,0);case u.Top:return new c.Z(0,-1);default:throw"Bad Anchor"}}static ReverseDirection(i){return(i+2)%4}static IndexToAnchor(i){switch(i){case 0:return u.Right;case 1:return u.Bottom;case 2:return u.Left;case 3:return u.Top;default:throw"Bad Index"}}static GetAnchorOffset(i){switch(i){case u.Top:return new c.Z(.5,0);case u.Bottom:return new c.Z(.5,1);case u.Left:return new c.Z(0,.5);case u.Right:return new c.Z(1,.5);default:throw"Bad Anchor"}}static GetExitRotation(i){switch(i){case u.Top:return 3*f;case u.Bottom:return f;case u.Left:return 2*f;case u.Right:return 0;default:throw"Bad Anchor"}}static GetEntryRotation(i){return g.GetExitRotation(g.ReverseDirection(i))}static GetRealPosition(i,t){var o=c.Z.multiply(i.position,t),n=c.Z.multiply(g.GetAnchorOffset(i.anchor),t);return o.addWith(n)}static GetMidpoint(i,t){return c.Z.multiply(i.position,t).addWith(c.Z.multiply(t,.5))}static GetConnection(i,t){return x[i][t]}}g.AllAnchors=[u.Right,u.Bottom,u.Left,u.Top];var w=o(2909);const m=64,v=new c.Z(m,m),R=new c.Z(18,18);var T=o(9934);class L{constructor(i,t,o,n){this.color=i,this.sprite=t,this.position=o,this.assets=n,this.nextPosition=void 0,this.parkedAt=void 0,this.parkAnimationComplete=!1,this.hasPlayedCrashAnimation=!1,this.flameRenders=[],this.animations=n.animationControllers[i],this.currentAnimationDefinition=void 0}isCrashed(){return void 0!==this.crashedAt}crashHere(i){this.isCrashed()||this.startFlames(),this.crashedAt={position:this.position.position,anchor:i}}crashAt(i){this.isCrashed()||this.startFlames(),this.crashedAt=i}FindOutputForAlwaysTurn(i,t,o,n){if(1===o.length)return o[0];if(0===n){const i=g.ReverseDirection(t);return-1!==o.indexOf(i)?i:t}for(let i=0;i<4;i++){let e=(t+i*n)%4;if(-1!==o.indexOf(e))return e}return t}startFlames(){const i=T.Z.Int(1,4);for(let t=0;t<i;t++){const i={anim:this.assets.fire.play(30,!0),offset:new c.Z(T.Z.Int(-6,6)-this.assets.fire.sourceSize.x/2,T.Z.Int(-6,6)-this.assets.fire.sourceSize.y)},t=T.Z.Int(8);for(let o=0;o<t;o++)i.anim.tick();this.flameRenders.push(i)}}EveryTick(){for(const i of this.flameRenders)i.anim.tick()}LogicTick(){this.isCrashed()&&!this.hasPlayedCrashAnimation&&(this.hasPlayedCrashAnimation=!0),this.currentAnimationDefinition=void 0}CalculateNextPosition(i){if(this.isCrashed())return void(this.hasPlayedCrashAnimation=!0);if(void 0!==this.parkedAt)return void(this.parkAnimationComplete=!0);const t=i.map[this.position.position.x][this.position.position.y],o=t.definition.connections.allConnections(this.position.anchor),n=this.chooseOutputDirection(i,t,o);if(void 0===n)return void(t.definition.isStop?(this.parkedAt=this.position.position,this.parkAnimationComplete=!1,(0,a.Yj)(i.cars,(i=>i!==this&&void 0!==i.parkedAt&&i.parkedAt.x===this.position.position.x&&i.parkedAt.y===this.position.position.y))&&this.crashHere(this.position.anchor)):this.crashHere());let e=this.position.anchor===n?"reverse":this.position.anchor===g.ReverseDirection(n)?"straight":this.position.anchor===(n+1)%4?"turnRight":"turnLeft";return this.currentAnimationDefinition=this.animations.animations[e],{position:c.Z.add(this.position.position,g.AnchorToTileMove(n)),anchor:g.ReverseDirection(n)}}chooseOutputDirection(i,t,o){switch(this.color){case l.Gray_Bounce:case l.Gray_TurnLeft:case l.Gray_TurnRight:return 0===o.length?this.position.anchor:this.FindOutputForAlwaysTurn(i,this.position.anchor,o,this.color===l.Gray_Bounce?0:this.color===l.Gray_TurnLeft?1:3);default:if(0===o.length)return;if(1===o.length)return o[0];{let i=t.TryGetSignal(this.position.anchor,this.color);return null!=i&&i!==this.position.anchor?i:-1!==o.indexOf(g.ReverseDirection(this.position.anchor))?g.ReverseDirection(this.position.anchor):void 0}}}draw(i,t,o){var n,e;const s=g.GetRealPosition(this.position,v),r=g.GetMidpoint(this.position,v),a=g.GetEntryRotation(this.position.anchor);let l,h;if(void 0===this.currentAnimationDefinition)l=this.sprite,h=!0;else{const i=t*this.currentAnimationDefinition.repeatCount%1,o=Math.floor(i*this.currentAnimationDefinition.numFrames);h=!(null!==(n=this.currentAnimationDefinition.overridesRotation)&&void 0!==n&&n),l=this.assets.carAnimations.getSprite(new c.Z(18*(this.currentAnimationDefinition.sourceOffset[0]+o),18*this.currentAnimationDefinition.sourceOffset[1]),new c.Z(18,18),new c.Z(.5,.5))}if(this.isCrashed()){let n;n=void 0!==this.nextPosition?this.nextPosition:void 0!==(null===(e=this.crashedAt)||void 0===e?void 0:e.anchor)?this.crashedAt:{position:c.Z.add(this.position.position,g.AnchorToTileMove(g.ReverseDirection(this.position.anchor))),anchor:this.position.anchor};const d=void 0===this.crashedAt.anchor?.4:.9,p=this.hasPlayedCrashAnimation?d:t<d?t:d,u=g.GetRealPosition(n,v);let x;x=void 0!==this.parkedAt?r:c.Z.Bezier([s,r,u],p),x=x.addWith(o);const y=g.GetEntryRotation(n.anchor),f=w.Z.relativeAngle(a,y);if(l.draw(i,x,l.sourceSize,h?a-f*p:a),this.hasPlayedCrashAnimation||t>p)for(const t of this.flameRenders)t.anim.draw(i,c.Z.add(x,t.offset),t.anim.source.sourceSize)}else if(void 0!==this.nextPosition){const n=g.GetRealPosition(this.nextPosition,v),e=c.Z.Bezier([s,r,n],t).addWith(o),d=g.GetEntryRotation(this.nextPosition.anchor),p=w.Z.relativeAngle(a,d);l.draw(i,e,l.sourceSize,h?a-p*t:a)}else if(void 0!==this.parkedAt)if(this.parkAnimationComplete)l.draw(i,r,l.sourceSize,a);else{const n=c.Z.Bezier([s,r,r],t).addWith(o);l.draw(i,n,l.sourceSize,a)}}}const B=new c.Z(88,88),S=[new c.Z(108,88),new c.Z(88,108),new c.Z(68,88),new c.Z(88,68)];new c.Z(0,64);class Z{constructor(i,t,o,n,e){this.tile=i,this.signal=t,this.assets=o,this.dx=n,this.dy=e,this.selectedColor=l.Red,this.colorButtonUp=this.assets.ctrlPanelElements.getSprite(new c.Z(0,0),new c.Z(63,32)),this.colorButtonDown=this.assets.ctrlPanelElements.getSprite(new c.Z(0,32),new c.Z(63,32)),this.sqButtonUp=this.assets.ctrlPanelElements.getSprite(new c.Z(63,0),new c.Z(16,16)),this.sqButtonDown=this.assets.ctrlPanelElements.getSprite(new c.Z(63,16),new c.Z(16,16)),this.roundButtonUp=this.assets.ctrlPanelElements.getSprite(new c.Z(63,32),new c.Z(16,16)),this.roundButtonDown=this.assets.ctrlPanelElements.getSprite(new c.Z(63,48),new c.Z(16,16)),this.arrowIndicators=[];for(let i=0;i<4;i++)this.arrowIndicators.push(this.assets.ctrlPanelElements.getSprite(new c.Z(79,16*i),new c.Z(16,16)))}tryHandleClick(i,t){if(i<this.dx||t<this.dy||i>this.dx+128||t>this.dy+128)return!1;if(i-=this.dx,t-=this.dy,i<=64){const i=Math.floor(t/32);return this.selectedColor=i,!0}if(t>=64){if(i>=B.x&&t>=B.y&&i<=B.x+16&&t<=B.y+16)this.signal.clearInstructions(this.selectedColor);else{let o;if(i-=64,t-=64,i-=32,t-=32,o=Math.abs(i)>=Math.abs(t)?i<0?y.Left:y.Right:t<0?y.Top:y.Bottom,-1===this.signal.definition.outputDirs.indexOf(o))return!0;this.signal.setInstruction(this.selectedColor,o)}return!0}return!0}draw(i){var t;this.assets.ctrlPanelBackground.image||console.log("ASSETS IMAGE: "+this.assets.ctrlPanelBackground.image),i.drawImage(this.assets.ctrlPanelBackground.image,this.dx,this.dy);for(let t=0;t<4;t++)(this.selectedColor===t?this.colorButtonDown:this.colorButtonUp).draw(i,new c.Z(this.dx+1,this.dy+32*t),new c.Z(63,32)),this.assets.carImageAtlas.getSprite(new c.Z(18*t,0),new c.Z(18,18)).draw(i,new c.Z(this.dx+1+31.5-8,this.dy+32*t+16-8),new c.Z(18,18));const o=null!==(t=this.signal.getInstruction(this.selectedColor))&&void 0!==t?t:-1;for(let t=0;t<4;t++)(o===t?this.sqButtonDown:this.sqButtonUp).draw(i,new c.Z(this.dx+S[t].x,this.dy+S[t].y),new c.Z(16,16)),this.arrowIndicators[t].draw(i,new c.Z(this.dx+S[t].x,this.dy+S[t].y),new c.Z(16,16));(-1===o?this.roundButtonDown:this.roundButtonUp).draw(i,new c.Z(this.dx+B.x,this.dy+B.y),new c.Z(16,16)),this.tile.draw_offgrid(i,this.dx+72,this.dy+8,48,this.assets)}}const A=[[p.LR,1023],[p.TB,1023],[p.RB,p.RB|p.LB|p.TR|p.RR|p.BB],[p.RT,p.RT|p.LT|p.RB|p.RR|p.TT],[p.BL,p.BL|p.RB|p.TL|p.BB|p.LL],[p.LT,p.LT|p.RT|p.LB|p.LL|p.TT],[p.RR,0],[p.BB,0],[p.LL,0],[p.TT,0]],C=[[p.LR,p.LR],[p.TB,p.TB],[p.RB,p.RB],[p.RT,p.RT],[p.BL,p.BL],[p.LT,p.LT],[p.RR,0],[p.BB,0],[p.LL,0],[p.TT,0]],b=[new c.Z(1,0),new c.Z(0,1),new c.Z(-1,0),new c.Z(0,-1)];class P{constructor(i){this.definition=i,this.currentSignals=new Map}disable(i){this.isDisabled=!0;for(let t=0;t<4;t++)for(let o=0;o<4;o++)1==(1&i)&&this.setInstruction(t,o),i>>=1}getInstruction(i){if(this.currentSignals.has(i))return this.currentSignals.get(i)}setInstruction(i,t){this.currentSignals.set(i,t)}clearInstructions(i){null==i?this.currentSignals.clear():this.currentSignals.delete(i)}getRenderPosition(i){return g.GetMidpoint({position:i},v).subtractWith(3,3).addWith(this.definition.dx,this.definition.dy)}draw(i,t,o,n){const e=g.GetMidpoint({position:t},v).subtractWith(3,3);o.render(i,e.x+this.definition.dx,e.y+this.definition.dy,6,6,this.isDisabled?1:0,0);const s=[0,0,0,0];for(var[r,a]of this.currentSignals.entries()){const t=s[a]++,o=b[a],l=c.Z.add(e,c.Z.multiply(o,6+3*t)).addWith(this.definition.dx,this.definition.dy);n.render(i,l.x,l.y,6,6,a,r)}}draw_offgrid(i,t,o,n,e){const s=t.addWith(c.Z.multiply(o,.5,.5)).subtractWith(3,3);n.render(i,s.x+this.definition.dx,s.y+this.definition.dy,6,6,this.isDisabled?1:0,0);const r=[0,0,0,0];for(var[a,l]of this.currentSignals.entries()){const t=r[l]++,o=b[l],n=c.Z.add(s,c.Z.multiply(o,6+3*t)).addWith(this.definition.dx,this.definition.dy);e.render(i,n.x,n.y,6,6,l,a)}}}class k{constructor(i,t,o){this.definition=i,this.image=t,this.endpointColor=o,this.signals=[];for(const t of i.signals)this.signals.push(new P(t));this.overdrawAnchors=3===this.definition.tileId?[y.Left,y.Right]:[]}DisableSignal(i,t){this.signals[i].disable(t)}TryGetSignal(i,t){for(const o of this.signals)if(-1!==o.definition.inputDirs.indexOf(i))return o.getInstruction(t)}CheckColisions(i,t){if(void 0===i.nextPosition||void 0===t.nextPosition)return!0;let o=g.GetConnection(i.position.anchor,g.ReverseDirection(i.nextPosition.anchor)),n=g.GetConnection(t.position.anchor,g.ReverseDirection(t.nextPosition.anchor));for(const[i,t]of this.definition.isCrossover?C:A){if(i===o&&(t&n)>0)return!0;if(i===n&&(t&o)>0)return!0}return!1}GetPositionAdjust(i,t,o){if(3===this.definition.tileId&&!(i!==y.Left&&i!==y.Right||t!==y.Left&&t!==y.Right)){let i=2*o;return i>1&&(i=1-i%1),i=Math.pow(i,.5),new c.Z(0,5*-i)}return new c.Z(0,0)}draw(i,t,o,n){this.image.draw(i,new c.Z(t*m,o*m),v);for(const e of this.signals)e.draw(i,new c.Z(t,o),n.signalHubSheet,n.signalArrowsImage);if(this.definition.isStop&&void 0!==this.endpointColor&&null!==this.endpointColor){const e=(m-n.spawnRingSheet.spriteWidth)/2;n.spawnRingSheet.render(i,t*m+e,o*m+e,n.spawnRingSheet.spriteWidth,n.spawnRingSheet.spriteHeight,this.endpointColor,1)}}overdraw(i,t,o,n){3===this.definition.tileId&&n.getTrackSprite(39).draw(i,new c.Z(t*m,o*m),v)}draw_offgrid(i,t,o,n,e){this.image.draw(i,new c.Z(t,o),new c.Z(n,n));for(const s of this.signals)s.draw_offgrid(i,new c.Z(t,o),new c.Z(n,n),e.signalHubSheet,e.signalArrowsImage)}}class E{constructor(i){this.connections=[];for(let t=0;t<4;t++){const o=[];for(let n=t;n<4;n++)o.push((1&i)>0),i>>=1;this.connections.push(o)}}connection(i,t,o){const n=g.AnchorToIndex(i),e=g.AnchorToIndex(t),s=Math.min(n,e),r=Math.max(n,e);if(void 0===o)return this.connections[s][r-s];this.connections[s][r-s]=o}allConnections(i){let t=[];for(const o of g.AllAnchors)this.connection(i,o)&&t.push(o);return t}}class _{constructor(i,t,o=!1,n=!1,e=!1){this.tileId=i,this.isStop=n,this.isCrossover=e,this.connections=new E(t),this.signals=[];for(const i of g.AllAnchors){const t=this.connections.allConnections(i);if(t.length>1){let n;o||0===this.signals.length?(n=Object.assign(Object.assign({},O(o,i)),{inputDirs:[],outputDirs:[]}),this.signals.push(n)):n=this.signals[0],n.inputDirs.push(i);for(const i of t)n.outputDirs.push(i)}}}}function O(i,t){if(!i)return{dx:0,dy:0};const o=g.AnchorToTileMove(t).multWith(16);return{dx:o.x,dy:o.y}}const I=[null,new _(1,p.TB),new _(2,p.LR),new _(3,p.TB|p.LR,!1,!1,!0),new _(4,p.RT),new _(5,p.RB),new _(6,p.LB),new _(7,p.LT),new _(8,p.RT|p.RB,!0),new _(9,p.RB|p.LB,!0),new _(10,p.LT|p.LB,!0),new _(11,p.LT|p.RT,!0),new _(12,p.RT|p.RB|p.TB),new _(13,p.RB|p.LB|p.LR),new _(14,p.LT|p.LB|p.TB),new _(15,p.LT|p.RT|p.LR),new _(16,0,!1,!0),new _(17,0,!1,!0),new _(18,0,!1,!0),new _(19,0,!1,!0),new _(20,p.LT|p.RB),new _(21,p.RT|p.LB),new _(22,p.RB|p.RT|p.LB|p.LT|p.LR|p.TB),new _(23,p.RB|p.RT|p.LB|p.LT,!0),new _(24,p.RR),new _(25,p.BB),new _(26,p.LL),new _(27,p.TT),new _(28,p.RR|p.TT),new _(29,p.BB|p.RR),new _(30,p.LL|p.BB),new _(31,p.TT|p.LL),new _(32,p.RR|p.TT|p.BB),new _(33,p.BB|p.RR|p.LL),new _(34,p.LL|p.BB|p.TT),new _(35,p.TT|p.LL|p.RR),new _(36,p.RR|p.LL),new _(37,p.BB|p.TT),new _(38,p.RR|p.LL|p.BB|p.TT),null,new _(39,p.RT|p.LL,!1,!1,!0),new _(40,p.RB|p.TT,!1,!1,!0),new _(41,p.LB|p.TT,!1,!1,!0),new _(42,p.LT|p.RR,!1,!1,!0),new _(43,p.RT|p.BB,!1,!1,!0),new _(44,p.RB|p.LL,!1,!1,!0),new _(45,p.LB|p.RR,!1,!1,!0),new _(46,p.LT|p.BB,!1,!1,!0),new _(47,p.RT|p.LL|p.BB,!1,!1,!0),new _(48,p.RB|p.TT|p.LL,!1,!1,!0),new _(49,p.LB|p.TT|p.RR,!1,!1,!0),new _(50,p.LT|p.RR|p.BB,!1,!1,!0)];class D{constructor(i,t,o){this.level=i,this.canvas=t,this.assets=o,this.map=[];for(let t=0;t<i.width;t++){let t=[];for(let o=0;o<i.height;o++)t.push(null);this.map.push(t)}let n=new Array(i.mapdata.length);for(const t of i.endpoints)n[t.position.x+t.position.y*i.width]=t.color;for(let t=0;t<i.mapdata.length;t++){let e=t%i.width,s=Math.floor(t/i.width);const r=I[i.mapdata[t]];this.map[e][s]=null===r?null:new k(r,o.getTrackSprite(r.tileId),n[t])}for(let t=0;t<i.disableSignals.length;t++)this.map[i.disableSignals[t].tile.x][i.disableSignals[t].tile.y].DisableSignal(i.disableSignals[t].signalIndex,i.disableSignals[t].forceSignals);this.ResetLevel()}tryGetOverlay(i,t){const o=new c.Z(Math.floor(i.x/m),Math.floor(i.y/m)),n=this.map[o.x][o.y];if(null==n||0===n.signals.length)return;const e=(0,a.gN)(n.signals,(t=>c.Z.subtract(t.getRenderPosition(o),i).lengthSq()));if(e.isDisabled)return;const s=new c.Z(o.x*m+m,o.y*m);return this.canvas.width/t-s.x<this.assets.ctrlPanelBackground.image.width&&(s.x=o.x*m-this.assets.ctrlPanelBackground.image.width),this.canvas.height/t-s.y<this.assets.ctrlPanelBackground.image.height&&(s.y=this.canvas.height/t-this.assets.ctrlPanelBackground.image.height),new Z(n,e,this.assets,s.x,s.y)}ResetLevel(){this.cars=[];for(const i of this.level.spawns)i.color>=0?this.cars.push(new L(i.color,this.assets.carImageAtlas.getSprite(new c.Z(18*i.color,0),R,new c.Z(.5,.5)),g.EquivalentPosition({position:new c.Z(i.position.x,i.position.y),anchor:i.direction}),this.assets)):this.cars.push(new L(i.color,this.assets.carImageAtlas.getSprite(new c.Z(18*(3-i.color),0),R,new c.Z(.5,.5)),g.EquivalentPosition({position:new c.Z(i.position.x,i.position.y),anchor:i.direction}),this.assets));this.updateCars()}updateCars(){for(const i of this.cars)i.LogicTick(),i.isCrashed()||(void 0!==i.nextPosition&&(i.position=i.nextPosition),i.nextPosition=i.CalculateNextPosition(this));for(const[i,t]of(0,a.V3)(this.cars,(i=>i.position.position),((i,t)=>i.x===t.x&&i.y===t.y)))for(let o=0;o<t.length;o++)for(let n=o+1;n<t.length;n++)this.map[i.x][i.y].CheckColisions(t[o],t[n])&&(t[o].crashHere(),t[n].crashHere());for(const i of this.cars){if(void 0===i.nextPosition)continue;const t=g.EquivalentPosition(i.nextPosition);for(const o of this.cars)i!==o&&void 0!==o.nextPosition&&t.anchor===o.nextPosition.anchor&&t.position.equals(o.nextPosition.position)&&(i.crashAt(i.nextPosition),o.crashAt(o.nextPosition))}}draw(i,t,o){var n,e;for(const i of this.cars)i.EveryTick();for(let i=0;i<this.map.length;i++)for(let o=0;o<this.map[i].length;o++)null!==this.map[i][o]&&this.map[i][o].draw(t,i,o,this.assets);const s=[];for(const i of this.cars){const e=this.map[i.position.position.x][i.position.position.y],r=i.position.anchor,c=null===(n=i.nextPosition)||void 0===n?void 0:n.anchor,l=[i.position,i.nextPosition,g.EquivalentPosition(i.position),g.EquivalentPosition(i.nextPosition)];(0,a.Yj)(l,(i=>void 0!==i&&-1!==this.map[i.position.x][i.position.y].overdrawAnchors.indexOf(i.anchor)))?s.push(i):i.draw(t,o,e.GetPositionAdjust(r,c,o))}for(let i=0;i<this.map.length;i++)for(let o=0;o<this.map[i].length;o++)null!==this.map[i][o]&&this.map[i][o].overdraw(t,i,o,this.assets);for(const i of s){const n=this.map[i.position.position.x][i.position.position.y],s=i.position.anchor,r=null===(e=i.nextPosition)||void 0===e?void 0:e.anchor;i.draw(t,o,n.GetPositionAdjust(s,r,o))}}}const G=JSON.parse('[{"id":0,"name":"Custom_1","width":8,"height":8,"mapdata":[5,26,16,6,17,5,6,17,8,6,24,23,22,3,20,7,8,7,24,22,15,22,15,6,12,33,6,1,17,4,13,7,12,22,14,12,14,5,15,6,12,22,14,12,14,4,13,7,8,22,10,12,14,5,11,6,4,15,15,15,15,15,2,7],"spawns":[{"position":{"x":2,"y":2},"color":0,"direction":0},{"position":{"x":2,"y":1},"color":3,"direction":0},{"position":{"x":5,"y":3},"color":-1,"direction":0},{"position":{"x":6,"y":4},"color":-1,"direction":0},{"position":{"x":6,"y":5},"color":-1,"direction":2},{"position":{"x":1,"y":3},"color":-1,"direction":1},{"position":{"x":1,"y":3},"color":2,"direction":0},{"position":{"x":1,"y":3},"color":0,"direction":2},{"position":{"x":4,"y":7},"color":-2,"direction":3},{"position":{"x":4,"y":5},"color":-2,"direction":3},{"position":{"x":3,"y":6},"color":-3,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":0},"color":3},{"position":{"x":2,"y":0},"color":0},{"position":{"x":4,"y":0},"color":2},{"position":{"x":4,"y":3},"color":0}]},{"id":1,"name":"Custom_2","width":8,"height":7,"mapdata":[0,0,25,25,25,25,24,6,5,13,22,22,22,22,13,14,1,1,1,37,1,37,4,7,4,15,22,22,22,22,13,6,0,0,37,1,37,1,1,1,0,16,22,22,22,22,15,7,0,0,27,27,27,27,0,0],"spawns":[{"position":{"x":6,"y":0},"color":0,"direction":0},{"position":{"x":5,"y":2},"color":-1,"direction":3},{"position":{"x":3,"y":2},"color":-1,"direction":3},{"position":{"x":4,"y":1},"color":-1,"direction":1},{"position":{"x":2,"y":0},"color":-1,"direction":1},{"position":{"x":3,"y":2},"color":-1,"direction":1},{"position":{"x":5,"y":2},"color":-1,"direction":1},{"position":{"x":4,"y":4},"color":-1,"direction":1},{"position":{"x":2,"y":5},"color":-1,"direction":1},{"position":{"x":6,"y":4},"color":-2,"direction":1},{"position":{"x":1,"y":2},"color":-2,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":1,"y":5},"color":0}]},{"id":2,"name":"Custom_3","width":8,"height":6,"mapdata":[5,13,26,17,17,0,0,0,4,14,16,23,23,2,6,0,17,4,9,23,23,26,1,0,12,13,23,10,4,2,7,0,12,23,14,4,6,0,25,0,28,15,15,18,4,2,7,0],"spawns":[{"position":{"x":2,"y":0},"color":0,"direction":2},{"position":{"x":6,"y":4},"color":0,"direction":1},{"position":{"x":0,"y":5},"color":0,"direction":0},{"position":{"x":0,"y":5},"color":0,"direction":3},{"position":{"x":5,"y":2},"color":0,"direction":2}],"disableSignals":[{"tile":{"x":1,"y":4},"signalIndex":3,"forceSignals":0},{"tile":{"x":1,"y":4},"signalIndex":0,"forceSignals":0}],"endpoints":[{"position":{"x":2,"y":1},"color":0},{"position":{"x":3,"y":0},"color":0},{"position":{"x":0,"y":2},"color":0},{"position":{"x":3,"y":5},"color":0},{"position":{"x":4,"y":0},"color":0}]},{"id":3,"name":"Original_Expert_1","width":8,"height":6,"mapdata":[5,13,13,2,2,13,13,6,1,27,12,13,9,14,1,1,12,2,23,22,23,22,7,1,1,16,14,1,1,1,24,14,19,25,1,12,3,14,16,14,0,4,15,15,15,15,2,7],"spawns":[{"position":{"x":6,"y":3},"color":3,"direction":0},{"position":{"x":1,"y":4},"color":3,"direction":1},{"position":{"x":1,"y":1},"color":1,"direction":3},{"position":{"x":3,"y":4},"color":-2,"direction":3},{"position":{"x":4,"y":2},"color":-2,"direction":3},{"position":{"x":5,"y":5},"color":-1,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":4},"color":3},{"position":{"x":1,"y":3},"color":3},{"position":{"x":6,"y":4},"color":1}]},{"id":4,"name":"Original_Expert_10","width":8,"height":6,"mapdata":[17,17,17,25,25,25,25,0,12,21,14,12,23,15,23,18,4,22,23,23,15,13,22,26,24,10,12,23,13,21,23,18,24,23,22,14,12,22,23,18,0,4,15,15,15,15,7,0],"spawns":[{"position":{"x":6,"y":0},"color":3,"direction":1},{"position":{"x":0,"y":3},"color":3,"direction":0},{"position":{"x":4,"y":0},"color":1,"direction":1},{"position":{"x":0,"y":4},"color":1,"direction":0},{"position":{"x":5,"y":0},"color":0,"direction":1}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":0},"color":2},{"position":{"x":1,"y":0},"color":1},{"position":{"x":2,"y":0},"color":3},{"position":{"x":7,"y":3},"color":3},{"position":{"x":7,"y":4},"color":1},{"position":{"x":7,"y":1},"color":0}]},{"id":5,"name":"Original_Expert_11","width":8,"height":6,"mapdata":[5,13,13,13,13,2,2,6,1,1,12,23,23,2,13,14,19,1,1,1,12,13,23,10,17,12,23,14,1,37,1,1,1,1,1,4,15,15,23,10,4,15,15,2,2,2,15,7],"spawns":[{"position":{"x":5,"y":3},"color":0,"direction":1},{"position":{"x":5,"y":3},"color":0,"direction":3},{"position":{"x":7,"y":1},"color":-1,"direction":3},{"position":{"x":2,"y":3},"color":-1,"direction":0},{"position":{"x":2,"y":5},"color":-1,"direction":0}],"disableSignals":[{"tile":{"x":5,"y":4},"signalIndex":0,"forceSignals":0}],"endpoints":[{"position":{"x":0,"y":2},"color":0},{"position":{"x":0,"y":3},"color":0}]},{"id":6,"name":"Original_Expert_2","width":8,"height":6,"mapdata":[5,6,25,25,5,26,0,0,12,14,1,1,1,17,17,17,12,15,15,15,15,15,15,14,12,2,2,2,2,2,2,14,12,2,2,2,2,2,2,14,4,2,2,2,2,2,2,7],"spawns":[{"position":{"x":3,"y":0},"color":0,"direction":1},{"position":{"x":2,"y":0},"color":1,"direction":1},{"position":{"x":5,"y":0},"color":3,"direction":2},{"position":{"x":6,"y":2},"color":-1,"direction":2},{"position":{"x":4,"y":3},"color":-2,"direction":2},{"position":{"x":1,"y":3},"color":-2,"direction":2},{"position":{"x":3,"y":4},"color":-2,"direction":0},{"position":{"x":7,"y":4},"color":-2,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":1},"color":0},{"position":{"x":6,"y":1},"color":1},{"position":{"x":5,"y":1},"color":3}]},{"id":7,"name":"Original_Expert_3","width":8,"height":6,"mapdata":[5,13,13,2,6,0,17,0,1,12,3,2,23,6,1,0,12,7,1,24,14,1,1,17,12,26,1,0,12,22,14,1,19,25,12,2,15,15,14,1,0,4,15,2,2,2,11,7],"spawns":[{"position":{"x":3,"y":2},"color":3,"direction":0},{"position":{"x":1,"y":4},"color":0,"direction":1},{"position":{"x":1,"y":3},"color":2,"direction":2},{"position":{"x":3,"y":0},"color":-2,"direction":2}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":4},"color":0},{"position":{"x":6,"y":0},"color":2},{"position":{"x":7,"y":2},"color":3}]},{"id":8,"name":"Original_Expert_4","width":8,"height":6,"mapdata":[5,2,6,5,13,13,13,6,8,6,19,1,4,15,15,14,8,3,9,14,5,13,13,7,8,23,23,11,14,1,1,25,12,14,1,5,15,7,8,7,4,11,7,4,2,2,7,0],"spawns":[{"position":{"x":7,"y":3},"color":0,"direction":1},{"position":{"x":2,"y":5},"color":-2,"direction":3},{"position":{"x":7,"y":0},"color":-2,"direction":2},{"position":{"x":4,"y":1},"color":-2,"direction":0},{"position":{"x":5,"y":1},"color":-3,"direction":3},{"position":{"x":4,"y":2},"color":-3,"direction":0},{"position":{"x":3,"y":2},"color":-3,"direction":1}],"disableSignals":[],"endpoints":[{"position":{"x":2,"y":1},"color":0}]},{"id":9,"name":"Original_Expert_5","width":8,"height":6,"mapdata":[24,2,2,6,5,2,18,0,0,0,0,12,14,0,5,18,16,2,13,14,12,13,7,0,5,2,15,14,12,15,2,18,1,24,13,7,4,13,26,0,19,24,15,2,2,15,26,0],"spawns":[{"position":{"x":0,"y":0},"color":2,"direction":0},{"position":{"x":6,"y":5},"color":2,"direction":2},{"position":{"x":1,"y":5},"color":1,"direction":0},{"position":{"x":1,"y":4},"color":0,"direction":0},{"position":{"x":6,"y":4},"color":3,"direction":2}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":5},"color":3},{"position":{"x":0,"y":2},"color":2},{"position":{"x":7,"y":3},"color":2},{"position":{"x":6,"y":0},"color":1},{"position":{"x":7,"y":1},"color":0}]},{"id":10,"name":"Original_Expert_6","width":8,"height":6,"mapdata":[16,9,2,9,13,2,9,26,5,14,0,1,4,6,1,0,1,8,13,22,2,15,10,0,4,14,1,1,0,0,12,26,0,8,15,22,2,2,10,0,0,19,0,27,0,0,19,0],"spawns":[{"position":{"x":7,"y":0},"color":0,"direction":2},{"position":{"x":7,"y":3},"color":0,"direction":2},{"position":{"x":3,"y":5},"color":0,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":1,"y":5},"color":0},{"position":{"x":6,"y":5},"color":0},{"position":{"x":0,"y":0},"color":0}]},{"id":11,"name":"Original_Expert_7","width":8,"height":6,"mapdata":[17,17,17,17,17,17,17,17,12,15,22,22,22,22,22,14,1,0,12,23,11,15,22,14,8,13,23,22,13,13,23,34,12,22,22,23,22,22,22,7,27,27,27,27,27,27,27,0],"spawns":[{"position":{"x":6,"y":5},"color":3,"direction":3},{"position":{"x":4,"y":5},"color":3,"direction":3},{"position":{"x":3,"y":5},"color":3,"direction":3},{"position":{"x":5,"y":5},"color":1,"direction":3},{"position":{"x":0,"y":5},"color":1,"direction":3},{"position":{"x":7,"y":3},"color":0,"direction":1},{"position":{"x":2,"y":5},"color":2,"direction":3},{"position":{"x":1,"y":5},"color":2,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":0},"color":3},{"position":{"x":7,"y":0},"color":3},{"position":{"x":4,"y":0},"color":3},{"position":{"x":6,"y":0},"color":1},{"position":{"x":2,"y":0},"color":1},{"position":{"x":1,"y":0},"color":0},{"position":{"x":3,"y":0},"color":2},{"position":{"x":5,"y":0},"color":2}]},{"id":12,"name":"Original_Expert_8","width":8,"height":6,"mapdata":[5,9,6,5,6,16,2,6,12,14,8,20,7,5,6,1,19,1,27,1,25,27,1,1,17,1,5,23,20,2,7,1,1,12,14,12,3,2,6,1,4,15,15,15,15,2,15,7],"spawns":[{"position":{"x":5,"y":2},"color":1,"direction":3},{"position":{"x":2,"y":2},"color":0,"direction":3},{"position":{"x":4,"y":2},"color":3,"direction":1},{"position":{"x":1,"y":2},"color":-1,"direction":3},{"position":{"x":3,"y":4},"color":-3,"direction":1}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":3},"color":3},{"position":{"x":0,"y":2},"color":1},{"position":{"x":5,"y":0},"color":0}]},{"id":13,"name":"Original_Expert_9","width":8,"height":6,"mapdata":[0,24,13,13,2,13,26,0,5,2,22,22,2,3,2,6,4,2,22,3,2,22,6,1,17,5,22,22,2,22,20,7,1,4,22,3,2,3,7,17,4,2,15,7,0,4,2,7],"spawns":[{"position":{"x":6,"y":0},"color":0,"direction":2},{"position":{"x":1,"y":0},"color":1,"direction":0},{"position":{"x":2,"y":1},"color":-1,"direction":2},{"position":{"x":4,"y":1},"color":-1,"direction":2},{"position":{"x":2,"y":2},"color":-1,"direction":0},{"position":{"x":5,"y":2},"color":-1,"direction":0},{"position":{"x":7,"y":2},"color":-1,"direction":3},{"position":{"x":3,"y":3},"color":-1,"direction":2},{"position":{"x":5,"y":3},"color":-1,"direction":2},{"position":{"x":6,"y":3},"color":-1,"direction":0},{"position":{"x":4,"y":4},"color":-1,"direction":0},{"position":{"x":1,"y":4},"color":-1,"direction":0}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":4},"color":1},{"position":{"x":0,"y":3},"color":0}]},{"id":14,"name":"Original_Genius_1","width":8,"height":6,"mapdata":[0,5,2,9,6,25,5,6,24,10,16,22,22,22,22,7,5,15,13,3,22,22,14,0,4,9,20,3,38,22,22,18,16,22,10,12,22,22,22,6,0,19,27,19,4,7,4,7],"spawns":[{"position":{"x":4,"y":3},"color":1,"direction":2},{"position":{"x":4,"y":3},"color":0,"direction":3},{"position":{"x":4,"y":3},"color":-1,"direction":1},{"position":{"x":6,"y":4},"color":-1,"direction":0},{"position":{"x":5,"y":3},"color":-2,"direction":3},{"position":{"x":2,"y":5},"color":2,"direction":3},{"position":{"x":0,"y":1},"color":2,"direction":0},{"position":{"x":5,"y":0},"color":3,"direction":1}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":3},"color":2},{"position":{"x":3,"y":5},"color":2},{"position":{"x":0,"y":4},"color":1},{"position":{"x":1,"y":5},"color":3},{"position":{"x":2,"y":1},"color":0}]},{"id":15,"name":"Original_Genius_2","width":8,"height":6,"mapdata":[5,2,6,25,0,25,5,6,12,2,10,4,9,23,20,7,1,17,4,2,11,10,12,18,1,8,9,9,9,10,12,26,8,10,8,10,8,15,11,6,19,4,15,15,11,2,2,7],"spawns":[{"position":{"x":3,"y":0},"color":0,"direction":1},{"position":{"x":5,"y":0},"color":1,"direction":1},{"position":{"x":7,"y":3},"color":3,"direction":2}],"disableSignals":[{"tile":{"x":6,"y":3},"signalIndex":0,"forceSignals":8224}],"endpoints":[{"position":{"x":0,"y":5},"color":0},{"position":{"x":1,"y":2},"color":1},{"position":{"x":7,"y":2},"color":3}]},{"id":16,"name":"Original_Genius_3","width":8,"height":6,"mapdata":[16,6,25,25,25,25,5,26,24,23,23,15,23,22,22,26,16,23,14,24,23,22,23,18,16,22,23,13,23,22,23,26,5,23,22,23,22,22,23,18,27,19,27,19,19,19,19,0],"spawns":[{"position":{"x":4,"y":0},"color":3,"direction":1},{"position":{"x":3,"y":0},"color":3,"direction":1},{"position":{"x":2,"y":0},"color":1,"direction":1},{"position":{"x":7,"y":0},"color":1,"direction":2},{"position":{"x":0,"y":1},"color":1,"direction":0},{"position":{"x":7,"y":1},"color":0,"direction":2},{"position":{"x":7,"y":3},"color":2,"direction":2},{"position":{"x":3,"y":2},"color":2,"direction":0},{"position":{"x":5,"y":0},"color":2,"direction":1},{"position":{"x":2,"y":5},"color":2,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":0,"y":0},"color":0},{"position":{"x":5,"y":5},"color":3},{"position":{"x":1,"y":5},"color":3},{"position":{"x":0,"y":3},"color":1},{"position":{"x":7,"y":4},"color":1},{"position":{"x":3,"y":5},"color":1},{"position":{"x":0,"y":2},"color":2},{"position":{"x":4,"y":5},"color":2},{"position":{"x":6,"y":5},"color":2},{"position":{"x":7,"y":2},"color":2}]},{"id":17,"name":"Original_Genius_4","width":8,"height":6,"mapdata":[24,6,5,6,5,6,5,18,24,23,14,1,1,1,12,6,24,23,14,12,14,12,23,14,24,22,14,12,14,12,23,7,24,23,14,1,1,12,23,18,0,19,4,7,4,7,19,0],"spawns":[{"position":{"x":0,"y":0},"color":0,"direction":0},{"position":{"x":0,"y":1},"color":3,"direction":0},{"position":{"x":0,"y":3},"color":3,"direction":0},{"position":{"x":0,"y":2},"color":1,"direction":0},{"position":{"x":2,"y":0},"color":-1,"direction":1},{"position":{"x":5,"y":3},"color":-2,"direction":3}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":0},"color":1},{"position":{"x":1,"y":5},"color":0},{"position":{"x":7,"y":4},"color":3},{"position":{"x":6,"y":5},"color":3}]},{"id":18,"name":"Original_Genius_5","width":8,"height":6,"mapdata":[24,6,17,17,17,5,13,26,24,22,23,23,23,22,23,18,16,23,22,38,22,23,23,18,24,22,23,23,23,22,23,6,5,15,14,19,27,1,19,19,4,2,7,0,0,27,0,0],"spawns":[{"position":{"x":3,"y":2},"color":0,"direction":3},{"position":{"x":0,"y":0},"color":2,"direction":0},{"position":{"x":0,"y":3},"color":2,"direction":0},{"position":{"x":5,"y":5},"color":2,"direction":3},{"position":{"x":3,"y":2},"color":1,"direction":1},{"position":{"x":3,"y":2},"color":1,"direction":0},{"position":{"x":3,"y":2},"color":3,"direction":2},{"position":{"x":7,"y":0},"color":3,"direction":2}],"disableSignals":[],"endpoints":[{"position":{"x":7,"y":1},"color":2},{"position":{"x":7,"y":2},"color":2},{"position":{"x":4,"y":0},"color":2},{"position":{"x":6,"y":4},"color":3},{"position":{"x":0,"y":2},"color":3},{"position":{"x":2,"y":0},"color":1},{"position":{"x":3,"y":4},"color":1},{"position":{"x":7,"y":4},"color":1},{"position":{"x":3,"y":0},"color":0}]},{"id":19,"name":"Original_Genius_6","width":8,"height":6,"mapdata":[24,6,0,17,0,17,0,17,24,23,2,23,13,23,13,7,24,23,2,22,23,22,23,26,24,23,26,1,8,23,14,0,24,23,2,15,23,22,15,18,24,7,0,0,19,19,0,0],"spawns":[{"position":{"x":0,"y":0},"color":2,"direction":0},{"position":{"x":0,"y":4},"color":2,"direction":0},{"position":{"x":7,"y":2},"color":0,"direction":2},{"position":{"x":0,"y":2},"color":1,"direction":0},{"position":{"x":0,"y":1},"color":3,"direction":0}],"disableSignals":[],"endpoints":[{"position":{"x":3,"y":0},"color":3},{"position":{"x":5,"y":5},"color":1},{"position":{"x":5,"y":0},"color":1},{"position":{"x":7,"y":0},"color":2},{"position":{"x":7,"y":4},"color":2},{"position":{"x":4,"y":5},"color":0}]},{"id":20,"name":"Original_Genius_7","width":8,"height":6,"mapdata":[0,16,13,2,9,13,6,25,24,9,23,13,20,14,27,1,5,11,23,38,22,22,13,14,12,26,12,11,23,22,15,7,1,16,23,18,8,22,18,17,4,2,11,2,11,15,2,7],"spawns":[{"position":{"x":7,"y":0},"color":0,"direction":1},{"position":{"x":6,"y":1},"color":2,"direction":3},{"position":{"x":3,"y":2},"color":2,"direction":0},{"position":{"x":0,"y":1},"color":1,"direction":0},{"position":{"x":1,"y":3},"color":1,"direction":2}],"disableSignals":[],"endpoints":[{"position":{"x":1,"y":0},"color":0},{"position":{"x":6,"y":4},"color":1},{"position":{"x":7,"y":4},"color":1},{"position":{"x":3,"y":4},"color":2},{"position":{"x":1,"y":4},"color":2}]}]'),M=o.p+"92b0680d8018abdf6ab4dce2cb8e7f4d.png",F=o.p+"40546b074d24707026ba482019c4d3b4.png",z=o.p+"068a4cb9e7cd5cde1c23e8fb17e230c2.png",W=o.p+"48175440e29eba81547fb6a3aae3f6ea.png",q=o.p+"c8060df9573385c396cd3cb0a91f4424.png",H=o.p+"f50a8f7fc9e146163272568decddbc2a.png",N=o.p+"560f633704b347d793db51e0a3fb7475.png",j=o.p+"dbe0d35db913eb26c862f06ff1aad1b0.png",U=o.p+"41279bc0b13b415202281fa495c04151.png";var Y=o(275),V=o(5922),J=o(3486),K=o(7475);class X{constructor(i){this.color=i,this.animations={}}addAnimation(i){if("string"==typeof i.conditions)this.animations[i.conditions]=i;else for(const t of i.conditions)this.animations[t]=i}}const $=JSON.parse('[{"carType":0,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,0],"numFrames":6},{"carType":0,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,1],"numFrames":6},{"carType":1,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,2],"numFrames":5},{"carType":1,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,3],"numFrames":5},{"carType":2,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,4],"numFrames":7},{"carType":2,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,5],"numFrames":7},{"carType":3,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,6],"numFrames":7},{"carType":3,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,7],"numFrames":7},{"carType":-1,"repeatCount":1,"conditions":"reverse","sourceOffset":[0,8],"numFrames":7,"overridesRotation":true},{"carType":-2,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,9],"numFrames":6},{"carType":-2,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,10],"numFrames":6},{"carType":-3,"repeatCount":1,"conditions":"turnLeft","sourceOffset":[0,9],"numFrames":6},{"carType":-3,"repeatCount":1,"conditions":"turnRight","sourceOffset":[0,10],"numFrames":6}]');class Q{constructor(i){this.trackImageAtlas=new Y.R(M,i.registerAssetLoadCallback()),this.carImageAtlas=new Y.R(F,i.registerAssetLoadCallback()),this.signalArrowsImage=new J.V(6,6,z,i.registerAssetLoadCallback()),this.signalHubSheet=new J.V(6,6,W,i.registerAssetLoadCallback()),this.ctrlPanelBackground=new V.Z(q,i.registerAssetLoadCallback()),this.ctrlPanelElements=new Y.R(N,i.registerAssetLoadCallback()),this.spawnRingSheet=new J.V(48,48,U,i.registerAssetLoadCallback()),this.carAnimations=new Y.R(j,i.registerAssetLoadCallback()),this.fire=new K.L(new Y.R(H,i.registerAssetLoadCallback()),new c.Z(0,0),new c.Z(8,16),4),this.animationControllers={};for(const i of h)this.animationControllers[i]=new X(i);for(const i of $)this.animationControllers[i.carType].addAnimation(i)}getTrackSprite(i){const t=i%4,o=Math.floor(i/4);return this.trackImageAtlas.getSprite(new c.Z(t*m,o*m),v)}}var ii=0;class ti{constructor(i){this.canvas=i,this.runnerID=ii++,console.log(`Create runner ${this.runnerID}`),(0,r.f5)(i,1024,768),this.ctx=i.getContext("2d"),this.ctx.save(),this.repaintTimer=-1,this.interpFrameCount=0,this.isRunning=!1,this.isDestroyed=!1,this.boundEventListener=this.handleMouseEvent.bind(this),this.overlay=void 0,i.addEventListener("click",this.boundEventListener)}handleKeyEvent(i){return"escape"===i.key&&(this.overlay=void 0,!0)}handleMouseEvent(i){var t,o;if(this.isRunning)return;const n=new c.Z(i.offsetX/this.canvasScale,i.offsetY/this.canvasScale);null!==(o=null===(t=this.overlay)||void 0===t?void 0:t.tryHandleClick(n.x,n.y))&&void 0!==o&&o||(this.overlay=this.gameState.tryGetOverlay(n,this.canvasScale))}start(){const i=new s.Z;this.assets=new Q(i),i.onAllFinished(this.loadComplete.bind(this))}toggleRunning(){this.gameState.ResetLevel(),this.interpFrameCount=0,this.isRunning=!this.isRunning,this.overlay=void 0}loadLevel(i){console.log("LOAD"),this.ctx.restore(),this.ctx.save();const t=i.width*m,o=i.height*m;console.log(2*t+", 1024"),2*t<=1024&&2*o<=1024?((0,r.f5)(this.canvas,2*t,2*o),(0,r.Ci)(this.ctx),this.ctx.scale(2,2),this.canvasScale=2):((0,r.f5)(this.canvas,t,o),this.canvasScale=1),this.gameState=new D(i,this.canvas,this.assets),this.interpFrameCount=0,this.overlay=void 0}loadComplete(){this.gameState=new D(G[0],this.canvas,this.assets),this.loadLevel(G[0]),this.runTick()}runTick(){this.isDestroyed||(this.tick(),this.draw(),this.repaintTimer=requestAnimationFrame(this.runTick.bind(this)))}tick(){this.isRunning?(this.interpFrameCount++,this.interpFrameCount>=40&&(this.interpFrameCount=0,this.gameState.updateCars())):this.interpFrameCount=0}draw(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.gameState.draw(this.canvas,this.ctx,this.interpFrameCount/40),this.ctx.restore(),void 0!==this.overlay&&this.overlay.draw(this.ctx)}stop(){-1!==this.repaintTimer&&cancelAnimationFrame(this.repaintTimer),this.isDestroyed=!0,this.canvas.removeEventListener("click",this.boundEventListener),console.log(`Destroy runner ${this.runnerID}`)}}const oi=o.p+"a787dffd8ab2ddec59191932b3f33b53.png",ni=16;function ei(i){const t=e.useRef();return e.useEffect((()=>{if(void 0===t.current||void 0===i.previewSheet)return;(0,r.f5)(t.current,ni*i.level.width,ni*i.level.height);const o=t.current.getContext("2d");o.clearRect(0,0,ni*i.level.width,ni*i.level.height);let n=0;for(var e=0;e<i.level.height;e++)for(var s=0;s<i.level.width;s++){const t=i.level.mapdata[n++],r=Math.floor(t%4),a=Math.floor(t/4);i.previewSheet.render(o,ni*s,ni*e,ni,ni,r,a)}}),[t.current]),e.createElement("div",{className:"flex row align-center",style:{border:"1px solid black",padding:"0 0 0 8px"},onClick:t=>i.onClick(t.nativeEvent)},e.createElement("span",null,i.level.id,": ",i.level.name),e.createElement("canvas",{ref:t}))}function si(){const i=e.useRef(),t=function(i,t){const[o,n]=(0,e.useState)(void 0);return(0,e.useEffect)((()=>{console.log("Reload item");const i=new s.Z,t=(o=i.registerAssetLoadCallback(),new J.V(ni,ni,oi,o));var o;i.onAllFinished((()=>{n(t)}))}),[]),o}(),[o,n]=e.useState(void 0),[r,a]=e.useState(!1);return e.useEffect((()=>{if(void 0===i.current)return;const t=new ti(i.current);return n(t),t.start(),()=>t.stop()}),[i.current,t]),void 0===t?e.createElement("div",null,"Loading..."):e.createElement("div",{className:"flex row"},e.createElement("canvas",{ref:i,tabIndex:0,onKeyDown:i=>{var t;32===i.keyCode?(null==o||o.toggleRunning(),i.preventDefault(),i.stopPropagation()):null!==(t=null==o?void 0:o.handleKeyEvent(i.nativeEvent))&&void 0!==t&&t&&(i.preventDefault(),i.stopPropagation())}}),e.createElement("div",{className:"flex col"},e.createElement("button",{onClick:i=>{o&&o.toggleRunning()}},"Start/Reset"),e.createElement("button",{onClick:()=>a(!r)},r?"Hide Level Select":"Show Level Select"),r?G.map((i=>e.createElement(ei,{key:i.id,level:i,previewSheet:t,onClick:t=>{null==o||o.loadLevel(i),t.preventDefault(),t.stopImmediatePropagation()}}))):e.createElement(e.Fragment,null)))}}}]);
//# sourceMappingURL=204.bundle.js.map